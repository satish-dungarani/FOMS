<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fabric Order Management System</title>

    <!-- Console Noise Filter (must be first to catch early warnings) -->
    <script>
        (function suppressKnownConsoleWarnings(){
            const originalWarn = console.warn;
            console.warn = function(...args){
                const msg = String(args?.[0] ?? '');
                const suppress = [
                    "Unrecognized feature: 'vr'",
                    "Unrecognized feature: 'ambient-light-sensor'",
                    "Unrecognized feature: 'battery'",
                    "An iframe which has both allow-scripts and allow-same-origin",
                    "enableIndexedDbPersistence() will be deprecated",
                    "cdn.tailwindcss.com should not be used in production"
                ].some(s => msg.includes(s));

                if (!suppress) originalWarn.apply(console, args);
            };
        })();
    </script>

    <!-- Tailwind config (must be defined before Tailwind browser runtime) -->
    <script>
        tailwind = window.tailwind || {};
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#64748b',
                    }
                }
            }
        };
    </script>
    <!-- Tailwind CSS (browser runtime) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr Datepicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF (A4 PDF export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs (Compat version for easier standalone usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile Optimizations */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; }

        /* Dark mode (CSS fallback so existing templates work without rewriting all classes)
           NOTE: We override common Tailwind utility classes used throughout the app, including hover states,
           subtle tinted backgrounds (blue-50, indigo-50, etc.), and 3rd-party widgets like Flatpickr.
        */
        .dark body { background: #0b1220 !important; color: #e5e7eb !important; }

        /* Base surfaces */
        .dark .bg-gray-50 { background-color: #0f172a !important; }
        .dark .bg-gray-100 { background-color: #0b1220 !important; }
        .dark .bg-white { background-color: #111827 !important; }
        .dark .bg-gray-200 { background-color: #1f2937 !important; }

        /* Text */
        .dark .text-gray-900,
        .dark .text-gray-800,
        .dark .text-gray-700 { color: #e5e7eb !important; }
        .dark .text-gray-600,
        .dark .text-gray-500 { color: #cbd5e1 !important; }
        .dark .text-gray-400 { color: #94a3b8 !important; }
        .dark .text-gray-300 { color: #cbd5e1 !important; }

        /* Borders / shadows */
        .dark .border-gray-100,
        .dark .border-gray-200,
        .dark .border-gray-300 { border-color: #1f2937 !important; }
        .dark .shadow-sm,
        .dark .shadow-lg,
        .dark .shadow-xl { box-shadow: 0 10px 30px rgba(0,0,0,0.45) !important; }

        /* Inputs */
        .dark input,
        .dark select,
        .dark textarea { background-color: #0f172a !important; color: #e5e7eb !important; border-color: #243047 !important; }
        .dark option { background-color: #0f172a !important; color: #e5e7eb !important; }

        /* Hover backgrounds (fix table row hover readability) */
        .dark .hover\:bg-gray-50:hover { background-color: #0f172a !important; }
        .dark .hover\:bg-gray-100:hover { background-color: #111827 !important; }
        .dark .hover\:bg-gray-200:hover { background-color: #1f2937 !important; }

        /* Sidebar + mobile bottom nav dark refinements */
        .dark #sidebar { background-color: #0b1220 !important; }
        .dark #sidebar .bg-slate-700 { background-color: #111827 !important; }
        .dark nav.md\:hidden.fixed.bottom-0 { background-color: #111827 !important; border-color: #1f2937 !important; }

        /* Light tinted backgrounds in dark mode (cards/buttons/badges) */
        .dark .bg-indigo-50 { background-color: rgba(99, 102, 241, 0.14) !important; }
        .dark .bg-indigo-100 { background-color: rgba(99, 102, 241, 0.18) !important; }
        .dark .bg-blue-50 { background-color: rgba(59, 130, 246, 0.14) !important; }
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.18) !important; }
        .dark .bg-green-50 { background-color: rgba(34, 197, 94, 0.14) !important; }
        .dark .bg-green-100 { background-color: rgba(34, 197, 94, 0.18) !important; }
        .dark .bg-yellow-50 { background-color: rgba(234, 179, 8, 0.14) !important; }
        .dark .bg-yellow-100 { background-color: rgba(234, 179, 8, 0.18) !important; }
        .dark .bg-purple-50 { background-color: rgba(168, 85, 247, 0.14) !important; }
        .dark .bg-purple-100 { background-color: rgba(168, 85, 247, 0.18) !important; }
        .dark .bg-red-50 { background-color: rgba(239, 68, 68, 0.14) !important; }
        .dark .bg-red-100 { background-color: rgba(239, 68, 68, 0.18) !important; }

        /* Tinted text colors in dark mode */
        .dark .text-indigo-600 { color: #a5b4fc !important; }
        .dark .text-blue-600 { color: #93c5fd !important; }
        .dark .text-green-600 { color: #86efac !important; }
        .dark .text-yellow-800 { color: #fde68a !important; }
        .dark .text-red-600 { color: #fca5a5 !important; }
        .dark .text-purple-600 { color: #d8b4fe !important; }

        /* Status pill defaults used by getStatusColor() */
        .dark .bg-blue-100.text-blue-800 { background: rgba(59,130,246,0.18) !important; color: #bfdbfe !important; }
        .dark .bg-yellow-100.text-yellow-800 { background: rgba(234,179,8,0.18) !important; color: #fde68a !important; }
        .dark .bg-green-100.text-green-800 { background: rgba(34,197,94,0.18) !important; color: #bbf7d0 !important; }
        .dark .bg-gray-100.text-gray-800 { background: rgba(148,163,184,0.16) !important; color: #e5e7eb !important; }

        /* Loading overlay (so it doesn't flash white in dark mode) */
        .dark #loading-overlay { background-color: rgba(17, 24, 39, 0.75) !important; }

        /* Modal container panel + overlay tweaks */
        .dark #modal-container .bg-white { background-color: #111827 !important; }
        .dark #modal-container .border-b { border-color: #1f2937 !important; }
        .dark #modal-container .border-t { border-color: #1f2937 !important; }

        /* Flatpickr dark theme */
        .dark .flatpickr-calendar {
            background: #111827 !important;
            border-color: #1f2937 !important;
            box-shadow: 0 12px 40px rgba(0,0,0,0.55) !important;
        }
        .dark .flatpickr-months .flatpickr-month,
        .dark .flatpickr-current-month,
        .dark .flatpickr-weekday {
            color: #e5e7eb !important;
        }
        .dark .flatpickr-day { color: #cbd5e1 !important; }
        .dark .flatpickr-day:hover { background: #0f172a !important; border-color: #0f172a !important; }
        .dark .flatpickr-day.today { border-color: #6366f1 !important; }
        .dark .flatpickr-day.selected,
        .dark .flatpickr-day.startRange,
        .dark .flatpickr-day.endRange {
            background: #4f46e5 !important;
            border-color: #4f46e5 !important;
            color: #ffffff !important;
        }
        .dark .flatpickr-time input,
        .dark .flatpickr-time .flatpickr-am-pm {
            background: #0f172a !important;
            color: #e5e7eb !important;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            #modal-content { height: auto !important; overflow: visible !important; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 antialiased h-screen overflow-hidden flex flex-col transition-colors duration-200">

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md relative">
            <div class="absolute top-4 right-4 flex items-center gap-2">
                <button onclick="app.toggleTheme()" class="text-gray-400 hover:text-indigo-600" title="Toggle theme" aria-label="Toggle theme">
                    <i class="fa-solid fa-moon" id="theme-icon-login"></i>
                </button>
                <button onclick="app.showDbSettingsPrompt()" class="text-gray-400 hover:text-indigo-600" title="Database settings" aria-label="Database settings">
                    <i class="fa-solid fa-database"></i>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <div id="login-logo-container" class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 mb-4 overflow-hidden">
                    <i class="fa-solid fa-layer-group text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900" id="login-company-name">Fabric OMS</h1>
                <p class="text-gray-500 text-sm">Realtime Order Management</p>
            </div>
            
            <!-- Connection Status Indicator -->
            <div id="db-status-badge" class="flex justify-center mb-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <span class="w-2 h-2 mr-1 bg-gray-400 rounded-full"></span> Local Storage
                </span>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" placeholder="admin" value="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" placeholder="admin" value="admin">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden">Invalid credentials</div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Sign In
                </button>
            </form>
            <div class="mt-4 text-center text-xs text-gray-400">
                Tap the database icon to connect Cloud DB
            </div>
        </div>
    </div>

    <!-- ================= APP LAYOUT ================= -->
    <div id="app-layout" class="flex-1 flex h-full overflow-hidden hidden relative">
        
        <!-- Sidebar (Desktop) -->
        <aside class="w-64 bg-slate-800 text-white flex-shrink-0 hidden md:flex flex-col transition-all duration-300" id="sidebar">
            <div class="p-4 border-b border-slate-700 flex items-center gap-3">
                <i class="fa-solid fa-layer-group text-indigo-400 text-xl" id="sidebar-logo"></i>
                <span class="font-bold text-lg tracking-wide" id="sidebar-company-name">Fabric OMS</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-2">
                <a href="#dashboard" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="dashboard">
                    <i class="fa-solid fa-chart-line w-6 mr-2 text-center"></i> Dashboard
                </a>
                <a href="#orders" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="orders">
                    <i class="fa-solid fa-cart-shopping w-6 mr-2 text-center"></i> Orders
                </a>
                <a href="#customers" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="customers">
                    <i class="fa-solid fa-users w-6 mr-2 text-center"></i> Parties
                </a>
                <a href="#brokers" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="brokers">
                    <i class="fa-solid fa-user-tie w-6 mr-2 text-center"></i> Brokers
                </a>
                <a href="#masters" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="masters">
                    <i class="fa-solid fa-database w-6 mr-2 text-center"></i> Masters
                </a>
                <a href="#reports" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="reports">
                    <i class="fa-solid fa-file-invoice w-6 mr-2 text-center"></i> Reports
                </a>
                <a href="#configuration" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-700 text-gray-300 hover:text-white" data-target="configuration">
                    <i class="fa-solid fa-sliders w-6 mr-2 text-center"></i> Configurations
                </a>
            </nav>
            <div class="p-4 border-t border-slate-700 space-y-4">
                <button onclick="app.toggleTheme()" class="flex items-center w-full text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-moon w-6 mr-2" id="theme-icon-desktop"></i> <span id="theme-label-desktop">Dark Mode</span>
                </button>
                <button onclick="app.logout()" class="flex items-center w-full text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-right-from-bracket w-6 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden bg-gray-50 relative">
            
            <!-- Header (Mobile Only) -->
            <header class="bg-white shadow-sm z-10 p-3 flex items-center justify-between md:hidden h-14">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-lg text-gray-800" id="mobile-company-name">Fabric OMS</span>
                    <span id="mobile-db-indicator" class="w-2 h-2 rounded-full bg-gray-400"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.toggleTheme()" class="text-gray-500 p-2" aria-label="Toggle theme">
                        <i class="fa-solid fa-moon" id="theme-icon-mobile"></i>
                    </button>
                    <button onclick="app.logout()" class="text-gray-500 p-2" aria-label="Logout">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </header>

            <!-- Scrollable Content Area -->
            <main id="content-area" class="flex-1 overflow-y-auto p-4 pb-24 md:p-8 md:pb-8">
                <!-- Content injected via JS -->
            </main>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-20 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
            </div>

            <!-- Bottom Mobile Navigation -->
            <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center z-40 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] h-16">
                <a href="#dashboard" class="mobile-nav-link flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 transition-colors" data-target="dashboard">
                    <i class="fa-solid fa-chart-line text-xl mb-1"></i>
                    <span class="text-[10px] font-medium">Home</span>
                </a>
                <a href="#orders" class="mobile-nav-link flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 transition-colors" data-target="orders">
                    <i class="fa-solid fa-cart-shopping text-xl mb-1"></i>
                    <span class="text-[10px] font-medium">Orders</span>
                </a>
                
                <!-- Floating Action Button for New Order -->
                <div class="relative -top-6">
                    <button onclick="app.navigateToOrderForm()" class="bg-indigo-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform border-4 border-gray-50">
                        <i class="fa-solid fa-plus text-2xl"></i>
                    </button>
                </div>

                <a href="#customers" class="mobile-nav-link flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 transition-colors" data-target="customers">
                    <i class="fa-solid fa-users text-xl mb-1"></i>
                    <span class="text-[10px] font-medium">Party</span>
                </a>
                <button onclick="app.toggleMobileMenu()" class="mobile-nav-link flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 transition-colors">
                    <i class="fa-solid fa-bars text-xl mb-1"></i>
                    <span class="text-[10px] font-medium">Menu</span>
                </button>
            </nav>

            <!-- Mobile More Menu (Slide up) -->
            <div id="mobile-more-menu" class="fixed inset-0 z-50 hidden md:hidden">
                <div class="absolute inset-0 bg-gray-900 bg-opacity-50 transition-opacity" onclick="app.toggleMobileMenu()"></div>
                <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-xl shadow-xl transform transition-transform duration-300 pb-safe animate-slide-up">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">Menu</h3>
                        <button onclick="app.toggleMobileMenu()" class="text-gray-500"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-6">
                        <a href="#brokers" onclick="app.toggleMobileMenu()" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center mb-2 text-blue-600">
                                <i class="fa-solid fa-user-tie text-xl"></i>
                            </div>
                            <span class="text-xs font-medium">Brokers</span>
                        </a>
                        <a href="#masters" onclick="app.toggleMobileMenu()" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center mb-2 text-purple-600">
                                <i class="fa-solid fa-database text-xl"></i>
                            </div>
                            <span class="text-xs font-medium">Masters</span>
                        </a>
                        <a href="#reports" onclick="app.toggleMobileMenu()" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center mb-2 text-green-600">
                                <i class="fa-solid fa-file-invoice text-xl"></i>
                            </div>
                            <span class="text-xs font-medium">Reports</span>
                        </a>
                        <a href="#configuration" onclick="app.toggleMobileMenu()" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center mb-2 text-orange-600">
                                <i class="fa-solid fa-sliders text-xl"></i>
                            </div>
                            <span class="text-xs font-medium">Configurations</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <!-- Modal Panel -->
        <div class="absolute inset-0 md:inset-auto md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:max-w-4xl md:w-full md:h-auto md:max-h-[90vh] bg-white md:rounded-lg shadow-xl overflow-hidden flex flex-col h-full">
            <div class="flex-1 overflow-y-auto p-4 md:p-6" id="modal-content">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- ================= TOAST NOTIFICATION ================= -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300 z-[60] text-sm pointer-events-none whitespace-nowrap">
        Notification
    </div>

    <!-- ================= IMAGE PREVIEW LIGHTBOX ================= -->
    <div id="image-lightbox" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center" onclick="app.closeLightbox(event)">
        <button onclick="app.closeLightbox()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10 w-12 h-12 flex items-center justify-center">
            <i class="fa-solid fa-times"></i>
        </button>
        <button onclick="app.prevImage(event)" class="absolute left-4 text-white text-3xl hover:text-gray-300 z-10 w-12 h-12 flex items-center justify-center">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <button onclick="app.nextImage(event)" class="absolute right-4 text-white text-3xl hover:text-gray-300 z-10 w-12 h-12 flex items-center justify-center">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
        <img id="lightbox-image" src="" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        <div id="lightbox-counter" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-sm bg-black/50 px-4 py-2 rounded-full"></div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- Console Noise Filter (hides known platform/embedding warnings) ---
        // These warnings are emitted by certain hosting environments / embedded iframes and are not caused by app logic.
        (function suppressKnownConsoleWarnings(){
            const originalWarn = console.warn;
            console.warn = function(...args){
                const msg = String(args?.[0] ?? '');
                const suppress = [
                    "Unrecognized feature: 'vr'",
                    "Unrecognized feature: 'ambient-light-sensor'",
                    "Unrecognized feature: 'battery'",
                    "An iframe which has both allow-scripts and allow-same-origin",
                    "enableIndexedDbPersistence() will be deprecated",
                    "cdn.tailwindcss.com should not be used in production"
                ].some(s => msg.includes(s));

                if (!suppress) originalWarn.apply(console, args);
            };
        })();

        // --- DATA STORE (Hybrid: LocalStorage + Firebase) ---
        const Store = {
            dbName: 'fabric_oms_db',
            useFirebase: false,
            db: null,
            storage: null,
            listeners: [],
            
            // Local state mirror (kept in sync with DB)
            data: {
                users: [{username: 'admin', password: 'admin'}],
                customers: [],
                brokers: [],
                orders: [],
                masters: {
                    fabrics: [
                        {id: 1, name: 'Cotton 60s', description: 'Pure Cotton', status: 'Active'},
                        {id: 2, name: 'Rayon 14kg', description: 'Heavy Rayon', status: 'Active'},
                        {id: 3, name: 'Polyester', description: 'Synthetic', status: 'Active'}
                    ],
                    units: [
                        {id: 1, name: 'Meters'},
                        {id: 2, name: 'Yards'},
                        {id: 3, name: 'Kg'}
                    ],
                    designs: [
                        {id: 1, name: 'Floral Print', status: 'Active'},
                        {id: 2, name: 'Geometric', status: 'Active'},
                        {id: 3, name: 'Plain Solid', status: 'Active'}
                    ],
                    mills: [
                        {id: 1, name: 'Arvind Mills', status: 'Active'},
                        {id: 2, name: 'Raymond', status: 'Active'},
                        {id: 3, name: 'Welspun', status: 'Active'}
                    ],
                    yarns: [
                        {id: 1, name: '30s', status: 'Active'},
                        {id: 2, name: '40s', status: 'Active'},
                        {id: 3, name: '60s', status: 'Active'}
                    ],
                    greyGsms: [
                        {id: 1, name: '160', status: 'Active'},
                        {id: 2, name: '180', status: 'Active'},
                        {id: 3, name: '200', status: 'Active'}
                    ],
                    spandexes: [
                        {id: 1, name: 'No', status: 'Active'},
                        {id: 2, name: '2%', status: 'Active'},
                        {id: 3, name: '4%', status: 'Active'}
                    ]
                }
            },

            normalizeFirebaseConfig(cfg) {
                // Many configs include storageBucket like "<project>.firebasestorage.app".
                // The actual default bucket for Firebase Storage is usually "<project>.appspot.com".
                // If we detect a firebasestorage.app value, convert it to appspot.com.
                if (!cfg || typeof cfg !== 'object') return cfg;
                const out = { ...cfg };
                if (out.projectId) {
                    // If storageBucket missing or in wrong form, normalize.
                    if (!out.storageBucket || typeof out.storageBucket !== 'string') {
                        out.storageBucket = `${out.projectId}.appspot.com`;
                    } else if (out.storageBucket.includes('firebasestorage.app')) {
                        out.storageBucket = `${out.projectId}.appspot.com`;
                    }
                }
                return out;
            },

            async init() {
                // Default Hardcoded Config
                const defaultConfig = {
                    apiKey: "AIzaSyBJIyDmTEn7BgsPy_tx1wgxwA1gFmqX7fI",
                    authDomain: "fab-oms.firebaseapp.com",
                    projectId: "fab-oms",
                    // NOTE: Firebase Storage bucket is typically <projectId>.appspot.com
                    storageBucket: "fab-oms.appspot.com",
                    messagingSenderId: "21494584900",
                    appId: "1:21494584900:web:f028d5e99881136c21ce11"
                };

                // Use localStorage config if exists (override), otherwise use default
                const localConfigStr = localStorage.getItem('oms_firebase_config');
                const rawConfig = localConfigStr ? JSON.parse(localConfigStr) : defaultConfig;
                const firebaseConfig = this.normalizeFirebaseConfig(rawConfig);

                if (firebaseConfig) {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        this.db = firebase.firestore();
                        this.storage = firebase.storage();
                        // NOTE: We intentionally avoid enablePersistence() here to prevent SDK deprecation warnings in console.
                        // Firestore still has offline caching by default in many environments.
                        this.useFirebase = true;
                        this.updateStatusUI(true);
                        // console.debug('Firebase Initialized', { projectId: firebaseConfig.projectId, storageBucket: firebaseConfig.storageBucket });
                        
                        // Setup Realtime Listeners
                        this.setupListeners();
                    } catch (e) {
                        console.error("Firebase Init Failed", e);
                        this.useFirebase = false;
                        this.updateStatusUI(false);
                        this.loadLocal();
                    }
                } else {
                    this.useFirebase = false;
                    this.updateStatusUI(false);
                    this.loadLocal();
                }
            },

            updateStatusUI(isOnline) {
                const badge = document.getElementById('db-status-badge');
                const dot = document.getElementById('mobile-db-indicator');
                
                if(isOnline) {
                    if(badge) badge.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="w-2 h-2 mr-1 bg-green-400 rounded-full animate-pulse"></span> Cloud DB Live</span>`;
                    if(dot) dot.classList.replace('bg-gray-400', 'bg-green-500');
                } else {
                    if(badge) badge.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><span class="w-2 h-2 mr-1 bg-gray-400 rounded-full"></span> Local Storage</span>`;
                    if(dot) dot.classList.replace('bg-green-500', 'bg-gray-400');
                }
            },

            loadLocal() {
                const stored = localStorage.getItem(this.dbName);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    this.data = parsed;
                    
                    // Migration: Ensure all master arrays exist (for old localStorage data)
                    if (!this.data.masters) this.data.masters = {};
                    if (!this.data.masters.fabrics) this.data.masters.fabrics = [
                        {id: 1, name: 'Cotton 60s', description: 'Pure Cotton', status: 'Active'},
                        {id: 2, name: 'Rayon 14kg', description: 'Heavy Rayon', status: 'Active'},
                        {id: 3, name: 'Polyester', description: 'Synthetic', status: 'Active'}
                    ];
                    if (!this.data.masters.units) this.data.masters.units = [
                        {id: 1, name: 'Meters'},
                        {id: 2, name: 'Yards'},
                        {id: 3, name: 'Kg'}
                    ];
                    if (!this.data.masters.designs) this.data.masters.designs = [
                        {id: 1, name: 'Floral Print', status: 'Active'},
                        {id: 2, name: 'Geometric', status: 'Active'},
                        {id: 3, name: 'Plain Solid', status: 'Active'}
                    ];
                    if (!this.data.masters.mills) this.data.masters.mills = [
                        {id: 1, name: 'Arvind Mills', status: 'Active'},
                        {id: 2, name: 'Raymond', status: 'Active'},
                        {id: 3, name: 'Welspun', status: 'Active'}
                    ];
                    if (!this.data.masters.yarns) this.data.masters.yarns = [
                        {id: 1, name: '30s', status: 'Active'},
                        {id: 2, name: '40s', status: 'Active'},
                        {id: 3, name: '60s', status: 'Active'}
                    ];
                    if (!this.data.masters.greyGsms) this.data.masters.greyGsms = [
                        {id: 1, name: '160', status: 'Active'},
                        {id: 2, name: '180', status: 'Active'},
                        {id: 3, name: '200', status: 'Active'}
                    ];
                    if (!this.data.masters.spandexes) this.data.masters.spandexes = [
                        {id: 1, name: 'No', status: 'Active'},
                        {id: 2, name: '2%', status: 'Active'},
                        {id: 3, name: '4%', status: 'Active'}
                    ];
                    
                    // Save migrated data
                    this.saveLocal();
                } else {
                    localStorage.setItem(this.dbName, JSON.stringify(this.data));
                }
            },

            setupListeners() {
                // Listen to collections and sync to local this.data
                const collections = ['customers', 'brokers', 'orders'];
                
                collections.forEach(col => {
                    const unsub = this.db.collection(col).onSnapshot(snapshot => {
                        const items = [];
                        snapshot.forEach(doc => items.push({ ...doc.data(), id: doc.id })); // Use doc.id as ID
                        this.data[col] = items;
                        // console.debug(`Synced ${col}: ${items.length} items`);
                        app.refreshCurrentView();
                    });
                    this.listeners.push(unsub);
                });

                // Masters is a single doc usually, but here we treat it simply
                // For simplicity in this demo, masters are stored in a 'settings' collection
                this.db.collection('settings').doc('masters').onSnapshot(doc => {
                    if(doc.exists) {
                        const incoming = doc.data() || {};
                        // IMPORTANT: Merge with defaults to ensure all arrays exist
                        this.data.masters = {
                            fabrics: incoming.fabrics || [],
                            units: incoming.units || [],
                            designs: incoming.designs || [],
                            mills: incoming.mills || [],
                            yarns: incoming.yarns || [],
                            greyGsms: incoming.greyGsms || [],
                            spandexes: incoming.spandexes || []
                        };
                        app.refreshCurrentView();
                    } else {
                        // Create default if missing - include all 4 master types
                        const defaultMasters = {
                            fabrics: [
                                {id: 1, name: 'Cotton 60s', description: 'Pure Cotton', status: 'Active'},
                                {id: 2, name: 'Rayon 14kg', description: 'Heavy Rayon', status: 'Active'},
                                {id: 3, name: 'Polyester', description: 'Synthetic', status: 'Active'}
                            ],
                            units: [
                                {id: 1, name: 'Meters'},
                                {id: 2, name: 'Yards'},
                                {id: 3, name: 'Kg'}
                            ],
                            designs: [
                                {id: 1, name: 'Floral Print', status: 'Active'},
                                {id: 2, name: 'Geometric', status: 'Active'},
                                {id: 3, name: 'Plain Solid', status: 'Active'}
                            ],
                            mills: [
                                {id: 1, name: 'Arvind Mills', status: 'Active'},
                                {id: 2, name: 'Raymond', status: 'Active'},
                                {id: 3, name: 'Welspun', status: 'Active'}
                            ],
                            yarns: [
                                {id: 1, name: '30s', status: 'Active'},
                                {id: 2, name: '40s', status: 'Active'},
                                {id: 3, name: '60s', status: 'Active'}
                            ],
                            greyGsms: [
                                {id: 1, name: '160', status: 'Active'},
                                {id: 2, name: '180', status: 'Active'},
                                {id: 3, name: '200', status: 'Active'}
                            ],
                            spandexes: [
                                {id: 1, name: 'No', status: 'Active'},
                                {id: 2, name: '2%', status: 'Active'},
                                {id: 3, name: '4%', status: 'Active'}
                            ]
                        };
                        this.data.masters = defaultMasters;
                        this.db.collection('settings').doc('masters').set(defaultMasters);
                    }
                });
            },

            // --- Firestore helpers ---
            sanitizeForFirestore(value) {
                // Firestore rejects undefined, NaN, Infinity, and certain nested entity patterns.
                // This function normalizes objects/arrays and drops invalid values.
                const clean = (v) => {
                    if (v === undefined) return null;
                    if (typeof v === 'number' && (!Number.isFinite(v) || Number.isNaN(v))) return 0;
                    if (v instanceof Date) return v.toISOString();
                    if (Array.isArray(v)) {
                        return v
                            .map(x => clean(x))
                            .filter(x => x !== null && x !== undefined);
                    }
                    if (v && typeof v === 'object') {
                        const out = {};
                        Object.keys(v).forEach(k => {
                            const cv = clean(v[k]);
                            if (cv !== undefined) out[k] = cv;
                        });
                        return out;
                    }
                    return v;
                };
                return clean(value);
            },

            async uploadImageDataUrl(dataUrl, path) {
                // For now, we skip Firebase Storage upload entirely to avoid CORS issues.
                // Images are stored as base64 directly in Firestore.
                // This works for small images. For large images, configure CORS on your bucket.
                // 
                // To enable cloud storage uploads later:
                // 1. Go to Google Cloud Console > Cloud Shell
                // 2. Run: echo '[{"origin": ["*"],"method": ["GET","HEAD","PUT","POST","DELETE"],"responseHeader": ["Content-Type"],"maxAgeSeconds": 3600}]' > cors.json
                // 3. Run: gsutil cors set cors.json gs://YOUR-BUCKET-NAME.appspot.com
                
                return dataUrl; // Return base64 as-is (stored inline in Firestore)
            },

            // --- CHALLAN NUMBER GENERATOR ---
            formatChallanId(year, seq) {
                const num = String(seq).padStart(4, '0');
                return `CH-${year}-${num}`;
            },

            async getNextChallanId(orderDateISO) {
                const year = (orderDateISO && String(orderDateISO).length >= 4)
                    ? String(orderDateISO).slice(0, 4)
                    : String(new Date().getFullYear());

                // Firebase mode: concurrency-safe counter using a transaction
                if (this.useFirebase && this.db) {
                    const counterRef = this.db.collection('settings').doc(`challanCounter-${year}`);
                    const nextSeq = await this.db.runTransaction(async (tx) => {
                        const snap = await tx.get(counterRef);
                        let seq = 0;
                        if (snap.exists) {
                            const data = snap.data() || {};
                            seq = Number(data.seq || 0);
                        }
                        seq = seq + 1;
                        tx.set(counterRef, {
                            year: Number(year),
                            seq,
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                        return seq;
                    });
                    return this.formatChallanId(year, nextSeq);
                }

                // Local mode: scan existing orders and pick next seq for the year
                const rx = new RegExp(`^CH-${year}-(\\d+)$`);
                let maxSeq = 0;
                (this.data.orders || []).forEach(o => {
                    const id = String(o.id || '');
                    const m = id.match(rx);
                    if (m && m[1]) {
                        const n = Number(m[1]);
                        if (Number.isFinite(n)) maxSeq = Math.max(maxSeq, n);
                    }
                });
                return this.formatChallanId(year, maxSeq + 1);
            },

            // --- CRUD Operations ---
            getAll(collection) { return this.data[collection] || []; },
            
            getById(collection, id) { 
                return this.data[collection].find(x => x.id == id); 
            },

            async add(collection, item) { 
                if (this.useFirebase) {
                    const docId = item.id;
                    const clean = this.sanitizeForFirestore(item);
                    await this.db.collection(collection).doc(docId.toString()).set(clean);
                } else {
                    this.data[collection].push(item); 
                    this.saveLocal();
                }
            },

            async update(collection, id, newData) {
                if (this.useFirebase) {
                    const clean = this.sanitizeForFirestore(newData);
                    await this.db.collection(collection).doc(id.toString()).update(clean);
                } else {
                    const idx = this.data[collection].findIndex(x => x.id == id);
                    if (idx !== -1) {
                        this.data[collection][idx] = { ...this.data[collection][idx], ...newData };
                        this.saveLocal();
                    }
                }
            },

            async delete(collection, id) {
                if (this.useFirebase) {
                    await this.db.collection(collection).doc(id.toString()).delete();
                } else {
                    this.data[collection] = this.data[collection].filter(x => x.id != id);
                    this.saveLocal();
                }
            },
            
            // Special handler for masters structure
            async saveMasters() {
                if(this.useFirebase) {
                    await this.db.collection('settings').doc('masters').set(this.data.masters);
                } else {
                    this.saveLocal();
                }
            },

            saveLocal() {
                localStorage.setItem(this.dbName, JSON.stringify(this.data));
                app.refreshCurrentView(); // Trigger re-render for local mode
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            currentUser: null,
            currentRoute: 'dashboard',

            // --- THEME (Light/Dark) ---
            theme: 'light',
            configurationTab: 'firm',

            initTheme() {
                const saved = localStorage.getItem('oms_theme');
                if (saved === 'dark' || saved === 'light') {
                    this.theme = saved;
                } else {
                    // Default: light
                    this.theme = 'light';
                }
                this.applyTheme(this.theme);
            },

            applyTheme(theme) {
                this.theme = theme === 'dark' ? 'dark' : 'light';
                const root = document.documentElement;
                if (this.theme === 'dark') root.classList.add('dark');
                else root.classList.remove('dark');

                localStorage.setItem('oms_theme', this.theme);

                // Update icons/labels
                const iconDesktop = document.getElementById('theme-icon-desktop');
                const labelDesktop = document.getElementById('theme-label-desktop');
                const iconMobile = document.getElementById('theme-icon-mobile');
                const iconLogin = document.getElementById('theme-icon-login');

                if (iconDesktop) {
                    iconDesktop.classList.remove('fa-moon', 'fa-sun');
                    iconDesktop.classList.add(this.theme === 'dark' ? 'fa-sun' : 'fa-moon');
                }
                if (labelDesktop) {
                    labelDesktop.textContent = this.theme === 'dark' ? 'Light Mode' : 'Dark Mode';
                }
                if (iconMobile) {
                    iconMobile.classList.remove('fa-moon', 'fa-sun');
                    iconMobile.classList.add(this.theme === 'dark' ? 'fa-sun' : 'fa-moon');
                }
                if (iconLogin) {
                    iconLogin.classList.remove('fa-moon', 'fa-sun');
                    iconLogin.classList.add(this.theme === 'dark' ? 'fa-sun' : 'fa-moon');
                }
            },

            toggleTheme() {
                this.applyTheme(this.theme === 'dark' ? 'light' : 'dark');
            },

            // Terminology: Customer -> Party (UI text only, does not change data keys)
            applyTerminology(root = document.body) {
                const skipTags = new Set(['SCRIPT', 'STYLE', 'TEXTAREA', 'INPUT', 'CODE', 'PRE']);
                const walker = document.createTreeWalker(
                    root,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: (node) => {
                            const p = node.parentElement;
                            if (!p) return NodeFilter.FILTER_REJECT;
                            if (skipTags.has(p.tagName)) return NodeFilter.FILTER_REJECT;
                            if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    }
                );

                const replacements = [
                    // plural
                    [/\bCustomers\b/g, 'Parties'],
                    [/\bcustomers\b/g, 'parties'],
                    // singular
                    [/\bCustomer\b/g, 'Party'],
                    [/\bcustomer\b/g, 'party'],
                    // short label used in mobile bottom nav
                    [/\bCust\b/g, 'Party'],
                    // invoice label
                    [/\bBill To\b/g, 'Party']
                ];

                while (walker.nextNode()) {
                    const n = walker.currentNode;
                    let t = n.nodeValue;
                    let changed = false;
                    for (const [rgx, rep] of replacements) {
                        if (rgx.test(t)) {
                            t = t.replace(rgx, rep);
                            changed = true;
                        }
                    }
                    if (changed) n.nodeValue = t;
                }
            },
            
            toggleMobileMenu() {
                const menu = document.getElementById('mobile-more-menu');
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                } else {
                    menu.classList.add('hidden');
                }
            },

            init() {
                this.initTheme();
                Store.init();
                this.loadCompanyConfig(); // Load branding immediately for login screen
                this.checkAuth();
                window.addEventListener('hashchange', () => this.handleRoute());
            },

            refreshCurrentView() {
                if(this.currentUser) {
                    this.handleRoute();
                }
            },

            checkAuth() {
                const session = sessionStorage.getItem('oms_session');
                if (session) {
                    this.currentUser = session;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');
                    // Ensure theme buttons (now visible) reflect current theme
                    this.applyTheme(this.theme);
                    this.handleRoute();
                    this.loadCompanyConfig(); // Load branding after login
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-layout').classList.add('hidden');
                    // Ensure login theme icon reflects current theme
                    this.applyTheme(this.theme);
                }
            },

            login(username, password) {
                // Hardcoded admin for simplicity as users aren't in Firestore yet
                if (username === 'admin' && password === 'admin') {
                    sessionStorage.setItem('oms_session', username);
                    this.checkAuth();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            },

            logout() {
                sessionStorage.removeItem('oms_session');
                window.location.reload();
            },

            handleRoute() {
                const hash = window.location.hash.substring(1) || 'dashboard';

                // If leaving order form, clear any draft state
                if (this.currentRoute === 'order-form' && hash !== 'order-form') {
                    this.tempOrder = null;
                    this.editingOrderId = null;
                }

                this.currentRoute = hash;
                
                // Update Desktop Sidebar UI
                document.querySelectorAll('.nav-link').forEach(el => {
                    if(el.dataset.target === hash) {
                        el.classList.add('bg-slate-700', 'text-white');
                        el.classList.remove('text-gray-300');
                    } else {
                        el.classList.remove('bg-slate-700', 'text-white');
                        el.classList.add('text-gray-300');
                    }
                });

                // Update Mobile Nav UI
                document.querySelectorAll('.mobile-nav-link').forEach(el => {
                    const target = el.dataset.target;
                    const isMoreMenu = !target; 
                    const secondaryRoutes = ['brokers', 'masters', 'reports', 'configuration'];

                    if(target === hash || (isMoreMenu && secondaryRoutes.includes(hash))) {
                        el.classList.add('text-indigo-600');
                        el.classList.remove('text-gray-400');
                    } else {
                        el.classList.remove('text-indigo-600');
                        el.classList.add('text-gray-400');
                    }
                });

                const content = document.getElementById('content-area');
                
                switch(hash) {
                    case 'dashboard': this.renderDashboard(content); break;
                    case 'orders': this.renderOrders(content); break;
                    case 'customers': this.renderCustomers(content); break;
                    case 'brokers': this.renderBrokers(content); break;
                    case 'masters': this.renderMasters(content); break;
                    case 'reports': this.renderReports(content); break;
                    case 'order-form': this.renderOrderFormPage(content); break;
                    case 'configuration': this.renderConfiguration(content); break;
                    default: this.renderDashboard(content); break;
                }

                // Apply UI terminology changes after each render
                this.applyTerminology(document.body);
            },

            // --- VIEW RENDERERS ---

            renderDashboard(container) {
                const orders = Store.getAll('orders');
                const customers = Store.getAll('customers');
                
                const stats = {
                    totalOrders: orders.length,
                    pending: orders.filter(o => o.status === 'New' || o.status === 'In Progress').length,
                    completed: orders.filter(o => o.status === 'Completed').length,
                    customers: customers.length
                };

                const recentOrders = [...orders].sort((a,b) => new Date(b.createdDate) - new Date(a.createdDate)).slice(0, 5);

                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-8">
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-indigo-500">
                            <div class="text-gray-500 text-xs md:text-sm">Total Orders</div>
                            <div class="text-2xl md:text-3xl font-bold">${stats.totalOrders}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-500">
                            <div class="text-gray-500 text-xs md:text-sm">Pending</div>
                            <div class="text-2xl md:text-3xl font-bold">${stats.pending}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                            <div class="text-gray-500 text-xs md:text-sm">Completed</div>
                            <div class="text-2xl md:text-3xl font-bold">${stats.completed}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                            <div class="text-gray-500 text-xs md:text-sm">Parties</div>
                            <div class="text-2xl md:text-3xl font-bold">${stats.customers}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Recent Orders</h3>
                            <button onclick="window.location.hash='orders'" class="text-indigo-600 text-sm hover:underline">View All</button>
                        </div>
                        <!-- Mobile List View -->
                        <div class="md:hidden divide-y divide-gray-100">
                             ${recentOrders.map(o => `
                                <div class="p-4" onclick="app.viewOrder('${o.id}')">
                                    <div class="flex justify-between mb-1">
                                        <span class="font-medium">${o.id}</span>
                                        <span class="text-xs px-2 py-0.5 rounded-full ${this.getStatusColor(o.status)}">${o.status}</span>
                                    </div>
                                    <div class="flex justify-between text-sm text-gray-500">
                                        <span>${o.customerName || 'Unknown'}</span>
                                        <span>${this.formatCurrency(this.calculateOrderTotal(o))}</span>
                                    </div>
                                </div>
                             `).join('')}
                              ${recentOrders.length === 0 ? '<div class="p-4 text-center text-gray-400">No recent orders</div>' : ''}
                        </div>
                        <!-- Desktop Table View -->
                        <div class="hidden md:block overflow-x-auto">
                            <table class="min-w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-gray-50 text-xs font-semibold text-gray-600 uppercase">
                                    <tr>
                                        <th class="px-6 py-3">Challan No.</th>
                                        <th class="px-6 py-3">Customer</th>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Amount</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${recentOrders.map(o => `
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="app.viewOrder('${o.id}')">
                                            <td class="px-6 py-3 font-medium text-gray-900">${o.id}</td>
                                            <td class="px-6 py-3">${o.customerName || 'Unknown'}</td>
                                            <td class="px-6 py-3">${this.formatDate(o.date)}</td>
                                            <td class="px-6 py-3"><span class="px-2 py-1 rounded-full text-xs ${this.getStatusColor(o.status)}">${o.status}</span></td>
                                            <td class="px-6 py-3">${this.formatCurrency(this.calculateOrderTotal(o))}</td>
                                        </tr>
                                    `).join('')}
                                    ${recentOrders.length === 0 ? '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-400">No recent orders</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            // Customer search state
            customerSearch: '',
            customerSearchTimeout: null,

            filterCustomers(query) {
                // Clear previous timeout
                if (this.customerSearchTimeout) {
                    clearTimeout(this.customerSearchTimeout);
                }
                
                // Update the stored value immediately (for display)
                this.customerSearch = query.toLowerCase();
                
                // Only filter if 3+ characters or empty (to reset)
                if (query.length >= 3 || query.length === 0) {
                    // Debounce the render to prevent focus loss
                    this.customerSearchTimeout = setTimeout(() => {
                        const searchInput = document.getElementById('customer-search');
                        const cursorPosition = searchInput ? searchInput.selectionStart : 0;
                        
                        this.renderCustomers(document.getElementById('content-area'));
                        
                        // Restore focus and cursor position after render
                        setTimeout(() => {
                            const newSearchInput = document.getElementById('customer-search');
                            if (newSearchInput) {
                                newSearchInput.focus();
                                newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                            }
                        }, 10);
                    }, 100);
                }
            },

            viewCustomerOrders(customerId) {
                // Set the filter to this customer and navigate to Orders
                this.orderFilters.customerId = customerId;
                this.orderFilters.search = '';
                this.orderFilters.brokerId = '';
                this.orderFilters.status = '';
                this.orderFilters.dateFrom = '';
                this.orderFilters.dateTo = '';
                window.location.hash = 'orders';
            },

            getCustomerOrderCount(customerId) {
                return Store.getAll('orders').filter(o => o.customerId === customerId).length;
            },

            renderCustomers(container) {
                let customers = Store.getAll('customers');
                const state = this.sortState.customers;
                
                // Apply search filter
                if (this.customerSearch) {
                    const q = this.customerSearch;
                    customers = customers.filter(c => 
                        (c.name || '').toLowerCase().includes(q) ||
                        (c.phone || '').toLowerCase().includes(q) ||
                        (c.company || '').toLowerCase().includes(q) ||
                        (c.city || '').toLowerCase().includes(q)
                    );
                }
                
                customers = this.sortData('customers', customers, state.column, state.direction);
                
                container.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-3">
                        <h2 class="text-2xl font-bold">Parties</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative flex-1 md:w-64">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                                <input type="text" id="customer-search" value="${this.customerSearch}" placeholder="Search (min 3 chars)..." oninput="app.filterCustomers(this.value)" class="w-full border rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            </div>
                            <button onclick="app.openCustomerModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm text-sm flex items-center whitespace-nowrap">
                                <i class="fa-solid fa-plus mr-1"></i> <span class="hidden md:inline">Add Party</span><span class="md:hidden">Add</span>
                            </button>
                        </div>
                    </div>

                    <!-- Mobile Card View -->
                    <div class="grid grid-cols-1 md:hidden gap-3">
                        ${customers.map(c => {
                            const orderCount = this.getCustomerOrderCount(c.id);
                            return `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-gray-900">${c.name}</div>
                                        <div class="text-sm text-gray-500">${c.company || 'Personal'}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="app.viewCustomerOrders('${c.id}')" class="text-indigo-600 p-2 bg-indigo-50 rounded-full relative" title="View Orders">
                                            <i class="fa-solid fa-file-lines text-xs"></i>
                                            ${orderCount > 0 ? `<span class="absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px] font-bold px-1.5 rounded-full">${orderCount}</span>` : ''}
                                        </button>
                                        <button onclick="app.openCustomerModal('${c.id}')" class="text-blue-600 p-2 bg-blue-50 rounded-full" title="Edit"><i class="fa-solid fa-pen text-xs"></i></button>
                                        <button onclick="app.deleteItem('customers', '${c.id}')" class="text-red-600 p-2 bg-red-50 rounded-full" title="Delete"><i class="fa-solid fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                <div class="mt-3 grid grid-cols-2 gap-2 text-sm text-gray-600">
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-phone text-gray-400"></i> <a href="tel:${c.phone}">${c.phone}</a></div>
                                    <div class="flex items-center gap-2"><i class="fa-solid fa-location-dot text-gray-400"></i> ${c.city || 'N/A'}</div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                        ${customers.length === 0 ? '<div class="text-center text-gray-400 py-8 bg-white rounded">No parties found</div>' : ''}
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden md:block bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="min-w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-xs font-semibold text-gray-600 uppercase border-b">
                                <tr>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('customers', 'name')">Name ${this.getSortIcon('customers', 'name')}</th>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('customers', 'phone')">Phone ${this.getSortIcon('customers', 'phone')}</th>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('customers', 'company')">Company ${this.getSortIcon('customers', 'company')}</th>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('customers', 'city')">City ${this.getSortIcon('customers', 'city')}</th>
                                    <th class="px-6 py-3 text-center">Orders</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${customers.map(c => {
                                    const orderCount = this.getCustomerOrderCount(c.id);
                                    return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-3 font-medium text-gray-900">${c.name || ''}</td>
                                        <td class="px-6 py-3">${c.phone || ''}</td>
                                        <td class="px-6 py-3">${c.company || '-'}</td>
                                        <td class="px-6 py-3">${c.city || '-'}</td>
                                        <td class="px-6 py-3 text-center">
                                            <button onclick="app.viewCustomerOrders('${c.id}')" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${orderCount > 0 ? 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200' : 'bg-gray-100 text-gray-500'} transition-colors" title="View Orders">
                                                <i class="fa-solid fa-file-lines"></i>
                                                <span>${orderCount}</span>
                                            </button>
                                        </td>
                                        <td class="px-6 py-3 text-right">
                                            <button onclick="app.openCustomerModal('${c.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Edit"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="app.deleteItem('customers', '${c.id}')" class="text-red-600 hover:text-red-900" title="Delete"><i class="fa-solid fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                                ${customers.length === 0 ? '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No parties found</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderBrokers(container) {
                let brokers = Store.getAll('brokers');
                const state = this.sortState.brokers;
                brokers = this.sortData('brokers', brokers, state.column, state.direction);
                
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <h2 class="text-2xl font-bold">Brokers</h2>
                        <button onclick="app.openBrokerModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm text-sm">
                            <i class="fa-solid fa-plus mr-1"></i> Add Broker
                        </button>
                    </div>

                    <!-- Mobile List -->
                    <div class="md:hidden space-y-3">
                        ${brokers.map(b => `
                            <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold">${b.name}</div>
                                    <div class="text-sm text-gray-500"><i class="fa-solid fa-phone mr-1"></i> ${b.phone}</div>
                                    <div class="text-xs bg-green-100 text-green-800 inline-block px-2 py-0.5 rounded mt-1">Comm: ${b.commission || 0}%</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.openBrokerModal('${b.id}')" class="text-blue-600 p-2"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="app.deleteItem('brokers', '${b.id}')" class="text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        ${brokers.length === 0 ? '<div class="text-center text-gray-400 py-8 bg-white rounded">No brokers found</div>' : ''}
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden md:block bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="min-w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-xs font-semibold text-gray-600 uppercase border-b">
                                <tr>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('brokers', 'name')">Name ${this.getSortIcon('brokers', 'name')}</th>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('brokers', 'phone')">Phone ${this.getSortIcon('brokers', 'phone')}</th>
                                    <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('brokers', 'commission')">Commission ${this.getSortIcon('brokers', 'commission')}</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${brokers.map(b => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-3 font-medium text-gray-900">${b.name || ''}</td>
                                        <td class="px-6 py-3">${b.phone || ''}</td>
                                        <td class="px-6 py-3">${b.commission || 0}%</td>
                                        <td class="px-6 py-3 text-right">
                                            <button onclick="app.openBrokerModal('${b.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="app.deleteItem('brokers', '${b.id}')" class="text-red-600 hover:text-red-900"><i class="fa-solid fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${brokers.length === 0 ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No brokers found</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            // Masters child-menu state
            mastersTab: 'designs',

            setMastersTab(tab) {
                this.mastersTab = tab;
                this.renderMasters(document.getElementById('content-area'));
            },

            renderMasters(container) {
                const masters = Store.data.masters || {};

                const tabs = [
                    { key: 'designs', label: 'Designs', icon: 'fa-palette' },
                    { key: 'mills', label: 'Mills', icon: 'fa-industry' },
                    { key: 'yarns', label: 'Yarn', icon: 'fa-ring' },
                    { key: 'greyGsms', label: 'Grey GSM', icon: 'fa-weight-scale' },
                    { key: 'spandexes', label: 'Spandex', icon: 'fa-wave-square' },
                    { key: 'fabrics', label: 'Fabric Types', icon: 'fa-scroll' },
                    { key: 'units', label: 'Units', icon: 'fa-ruler' }
                ];

                const active = tabs.find(t => t.key === this.mastersTab) || tabs[0];
                const items = (masters[active.key] || []);

                const listHtml = `
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i class="fa-solid ${active.icon} text-indigo-500"></i>
                                <span>${active.label}</span>
                            </h3>
                            <button onclick="app.openMasterModal('${active.key}')" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-colors">
                                <i class="fa-solid fa-plus mr-1"></i> Add
                            </button>
                        </div>
                        <ul class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto">
                            ${items.map(item => `
                                <li class="py-3 flex justify-between items-center px-2">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <span class="font-medium text-gray-700 truncate">${item.name}</span>
                                        <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${item.status === 'Inactive' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${item.status || 'Active'}</span>
                                    </div>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="app.openMasterModal('${active.key}', ${item.id})" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50" title="Edit">
                                            <i class="fa-solid fa-pen text-sm"></i>
                                        </button>
                                        <button onclick="app.confirmDeleteMaster('${active.key}', ${item.id}, '${item.name}')" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50" title="Delete">
                                            <i class="fa-solid fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </li>
                            `).join('')}
                            ${items.length === 0 ? `
                                <li class="py-10 text-center text-gray-400">
                                    <i class="fa-solid ${active.icon} text-4xl mb-2 opacity-30"></i>
                                    <p class="text-sm">No ${active.label.toLowerCase()} added yet</p>
                                </li>
                            ` : ''}
                        </ul>
                        ${items.length > 0 ? `<div class="mt-3 pt-3 border-t text-xs text-gray-400 text-center">${items.length} item${items.length > 1 ? 's' : ''}</div>` : ''}
                    </div>
                `;

                container.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                        <h2 class="text-2xl font-bold">Masters</h2>
                        <div class="text-xs text-gray-500">Manage dropdowns used in Orders</div>
                    </div>

                    <!-- Mobile: Grid of icon buttons | Desktop: Horizontal scrollable tabs -->
                    <!-- Mobile View (Grid) -->
                    <div class="md:hidden grid grid-cols-4 gap-2 mb-4">
                        ${tabs.map(t => {
                            const isActive = t.key === active.key;
                            return `
                                <button onclick="app.setMastersTab('${t.key}')" class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}">
                                    <i class="fa-solid ${t.icon} text-lg mb-1"></i>
                                    <span class="text-[10px] font-bold leading-tight text-center">${t.label}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>

                    <!-- Desktop View (Horizontal Tabs) -->
                    <div class="hidden md:block bg-white rounded-lg shadow-sm p-2 mb-4">
                        <div class="flex gap-2 flex-wrap">
                            ${tabs.map(t => {
                                const isActive = t.key === active.key;
                                return `
                                    <button onclick="app.setMastersTab('${t.key}')" class="px-4 py-2 rounded-lg text-sm font-bold border transition-colors flex items-center gap-2 ${isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-gray-50 text-gray-700 border-gray-200 hover:bg-gray-100'}">
                                        <i class="fa-solid ${t.icon}"></i>
                                        <span>${t.label}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    ${listHtml}
                `;
            },

            // Order filter state
            orderFilters: {
                search: '',
                customerId: '',
                brokerId: '',
                status: '',
                dateFrom: '',
                dateTo: ''
            },
            orderSearchTimeout: null,

            resetOrderFilters() {
                this.orderFilters = {
                    search: '',
                    customerId: '',
                    brokerId: '',
                    status: '',
                    dateFrom: '',
                    dateTo: ''
                };
                this.renderOrders(document.getElementById('content-area'));
            },

            filterOrdersDebounced(query) {
                // Clear previous timeout
                if (this.orderSearchTimeout) {
                    clearTimeout(this.orderSearchTimeout);
                }
                
                // Update the stored value immediately
                this.orderFilters.search = query;
                
                // Only filter if 3+ characters or empty (to reset)
                if (query.length >= 3 || query.length === 0) {
                    // Debounce the render
                    this.orderSearchTimeout = setTimeout(() => {
                        const searchInput = document.getElementById('filter-search');
                        const cursorPosition = searchInput ? searchInput.selectionStart : 0;
                        
                        this.renderOrders(document.getElementById('content-area'));
                        
                        // Restore focus and cursor position
                        setTimeout(() => {
                            const newSearchInput = document.getElementById('filter-search');
                            if (newSearchInput) {
                                newSearchInput.focus();
                                newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                            }
                        }, 10);
                    }, 100);
                }
            },

            // Convert dd/mm/yyyy to yyyy-mm-dd for comparison
            parseDateInput(dateStr) {
                if (!dateStr) return '';
                // If already in yyyy-mm-dd format
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
                // Parse dd/mm/yyyy
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const [day, month, year] = parts;
                    if (day && month && year && year.length === 4) {
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                }
                return '';
            },

            // Format yyyy-mm-dd to dd/mm/yyyy for display in inputs
            formatDateForInput(dateStr) {
                if (!dateStr) return '';
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                return dateStr;
            },

            applyOrderFilters() {
                // Don't override search - it's handled by filterOrdersDebounced
                // this.orderFilters.search is already set
                this.orderFilters.customerId = document.getElementById('filter-customer')?.value || '';
                this.orderFilters.brokerId = document.getElementById('filter-broker')?.value || '';
                this.orderFilters.status = document.getElementById('filter-status')?.value || '';
                
                // Parse date inputs from dd/mm/yyyy to yyyy-mm-dd
                const fromInput = document.getElementById('filter-date-from')?.value || '';
                const toInput = document.getElementById('filter-date-to')?.value || '';
                this.orderFilters.dateFrom = this.parseDateInput(fromInput);
                this.orderFilters.dateTo = this.parseDateInput(toInput);
                
                this.renderOrders(document.getElementById('content-area'));
            },

            initDatePickers() {
                const fromEl = document.getElementById('filter-date-from');
                const toEl = document.getElementById('filter-date-to');
                
                if (fromEl) {
                    flatpickr(fromEl, {
                        dateFormat: 'd/m/Y',
                        allowInput: false,
                        clickOpens: true,
                        defaultDate: this.formatDateForInput(this.orderFilters.dateFrom),
                        maxDate: this.orderFilters.dateTo ? this.formatDateForInput(this.orderFilters.dateTo) : undefined,
                        onChange: (selectedDates, dateStr) => {
                            this.orderFilters.dateFrom = this.parseDateInput(dateStr);
                            
                            // Ensure From Date <= To Date
                            if (this.orderFilters.dateTo && this.orderFilters.dateFrom > this.orderFilters.dateTo) {
                                this.orderFilters.dateTo = ''; // Clear invalid range
                            }
                            
                            this.renderOrders(document.getElementById('content-area'));
                        }
                    });
                }
                
                if (toEl) {
                    flatpickr(toEl, {
                        dateFormat: 'd/m/Y',
                        allowInput: false,
                        clickOpens: true,
                        defaultDate: this.formatDateForInput(this.orderFilters.dateTo),
                        minDate: this.orderFilters.dateFrom ? this.formatDateForInput(this.orderFilters.dateFrom) : undefined,
                        onChange: (selectedDates, dateStr) => {
                            this.orderFilters.dateTo = this.parseDateInput(dateStr);
                            
                            // Ensure To Date >= From Date
                            if (this.orderFilters.dateFrom && this.orderFilters.dateTo < this.orderFilters.dateFrom) {
                                this.orderFilters.dateFrom = ''; // Clear invalid range
                            }
                            
                            this.renderOrders(document.getElementById('content-area'));
                        }
                    });
                }
            },

            getFilteredOrders() {
                let orders = Store.getAll('orders');
                const f = this.orderFilters;

                // Apply search filter
                if (f.search) {
                    const q = f.search.toLowerCase();
                    orders = orders.filter(o => 
                        o.id.toLowerCase().includes(q) || 
                        (o.customerName || '').toLowerCase().includes(q)
                    );
                }

                // Apply customer filter
                if (f.customerId) {
                    orders = orders.filter(o => o.customerId === f.customerId);
                }

                // Apply broker filter
                if (f.brokerId) {
                    orders = orders.filter(o => o.brokerId === f.brokerId);
                }

                // Apply status filter
                if (f.status) {
                    orders = orders.filter(o => o.status === f.status);
                }

                // Apply date from filter
                if (f.dateFrom) {
                    orders = orders.filter(o => o.date >= f.dateFrom);
                }

                // Apply date to filter
                if (f.dateTo) {
                    orders = orders.filter(o => o.date <= f.dateTo);
                }

                return orders;
            },

            toggleOrderFilters() {
                const panel = document.getElementById('order-filters-panel');
                if (panel) {
                    panel.classList.toggle('hidden');
                }
            },

            renderOrders(container) {
                let orders = this.getFilteredOrders();
                const state = this.sortState.orders;
                orders = this.sortData('orders', orders, state.column, state.direction);
                
                const customers = Store.getAll('customers');
                const brokers = Store.getAll('brokers');
                const f = this.orderFilters;
                const hasActiveFilters = f.customerId || f.brokerId || f.status || f.dateFrom || f.dateTo;
                
                container.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <h2 class="text-2xl font-bold">Orders</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative flex-1 md:w-64">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                                <input type="text" id="filter-search" value="${f.search}" placeholder="Search (min 3 chars)..." oninput="app.filterOrdersDebounced(this.value)" class="w-full border rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            </div>
                            <button onclick="app.toggleOrderFilters()" class="flex items-center gap-2 px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 ${hasActiveFilters ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'text-gray-600'}">
                                <i class="fa-solid fa-filter"></i>
                                <span class="hidden md:inline">Filters</span>
                                ${hasActiveFilters ? '<span class="w-2 h-2 bg-indigo-500 rounded-full"></span>' : ''}
                            </button>
                            <button onclick="app.navigateToOrderForm()" class="hidden md:flex bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm text-sm items-center whitespace-nowrap">
                                <i class="fa-solid fa-plus mr-1"></i> New Order
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Filters Panel -->
                    <div id="order-filters-panel" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4 ${hasActiveFilters ? '' : 'hidden'}">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider">Filter Orders</h3>
                            <button onclick="app.resetOrderFilters()" class="text-xs text-red-500 hover:text-red-700 font-medium">
                                <i class="fa-solid fa-times-circle mr-1"></i>Clear All
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <!-- Customer -->
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Party</label>
                                <select id="filter-customer" onchange="app.applyOrderFilters()" class="w-full border border-gray-200 rounded-lg p-2 text-sm bg-white">
                                    <option value="">All Parties</option>
                                    ${customers.map(c => `<option value="${c.id}" ${f.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Broker -->
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Broker</label>
                                <select id="filter-broker" onchange="app.applyOrderFilters()" class="w-full border border-gray-200 rounded-lg p-2 text-sm bg-white">
                                    <option value="">All Brokers</option>
                                    ${brokers.map(b => `<option value="${b.id}" ${f.brokerId === b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Status -->
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Status</label>
                                <select id="filter-status" onchange="app.applyOrderFilters()" class="w-full border border-gray-200 rounded-lg p-2 text-sm bg-white">
                                    <option value="">All Status</option>
                                    <option value="New" ${f.status === 'New' ? 'selected' : ''}>New</option>
                                    <option value="In Progress" ${f.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${f.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                            
                            <!-- Date From -->
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">From Date</label>
                                <input type="text" id="filter-date-from" value="${this.formatDateForInput(f.dateFrom)}" placeholder="dd/mm/yyyy" readonly class="w-full border border-gray-200 rounded-lg p-2 text-sm bg-white cursor-pointer">
                            </div>
                            
                            <!-- Date To -->
                            <div>
                                <label class="block text-[10px] text-gray-500 uppercase font-bold mb-1">To Date</label>
                                <input type="text" id="filter-date-to" value="${this.formatDateForInput(f.dateTo)}" placeholder="dd/mm/yyyy" readonly class="w-full border border-gray-200 rounded-lg p-2 text-sm bg-white cursor-pointer">
                            </div>
                            
                            <!-- Results Count -->
                            <div class="flex items-end">
                                <div class="w-full bg-gray-50 rounded-lg p-2 text-center">
                                    <span class="text-lg font-bold text-indigo-600">${orders.length}</span>
                                    <span class="text-xs text-gray-500 block">Results</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Card View -->
                    <div class="md:hidden space-y-4 pb-8" id="orders-list-mobile">
                        ${orders.map(o => {
                            const orderImages = this.getOrderImages(o);
                            return `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 search-item" data-search="${o.id} ${o.customerName}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-lg">${o.id}</div>
                                        <div class="text-xs text-gray-400">${this.formatDate(o.date)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${this.getStatusColor(o.status)}">${o.status}</span>
                                </div>
                                <div class="mb-3">
                                    <div class="font-medium text-gray-800">${o.customerName}</div>
                                    <div class="text-sm text-gray-500">${o.items.length} Items  ${o.priority}</div>
                                </div>
                                
                                <!-- Images Row -->
                                ${orderImages.length > 0 ? `
                                <div class="flex gap-2 mb-3 overflow-x-auto pb-2 hide-scrollbar">
                                    ${orderImages.map((img, idx) => `
                                        <img src="${img}" onclick="event.stopPropagation(); app.openLightbox(${JSON.stringify(orderImages).replace(/"/g, '&quot;')}, ${idx})" 
                                             class="w-12 h-12 rounded-lg object-cover cursor-pointer border border-gray-200 flex-shrink-0 active:scale-95 transition-transform">
                                    `).join('')}
                                </div>
                                ` : ''}
                                
                                <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                                    <div class="font-bold text-gray-900 text-lg">${this.formatCurrency(this.calculateOrderTotal(o))}</div>
                                    <div class="flex gap-4">
                                        <button onclick="app.downloadOrderFormPdf('${o.id}')" class="text-indigo-600" title="PDF"><i class="fa-solid fa-file-arrow-down text-lg"></i></button>
                                        <button onclick="app.viewOrder('${o.id}')" class="text-gray-500" title="View"><i class="fa-solid fa-eye text-lg"></i></button>
                                        <button onclick="app.navigateToOrderForm('${o.id}')" class="text-blue-600" title="Edit"><i class="fa-solid fa-pen text-lg"></i></button>
                                        <button onclick="app.deleteItem('orders', '${o.id}')" class="text-red-500" title="Delete"><i class="fa-solid fa-trash text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                        ${orders.length === 0 ? '<div class="text-center text-gray-400 py-8">No orders found</div>' : ''}
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden md:block bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="min-w-full text-left text-sm whitespace-nowrap" id="orders-table">
                            <thead class="bg-gray-50 text-xs font-semibold text-gray-600 uppercase border-b">
                                <tr>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('orders', 'id')">Challan No. ${this.getSortIcon('orders', 'id')}</th>
                                    <th class="px-4 py-3">Images</th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('orders', 'date')">Date ${this.getSortIcon('orders', 'date')}</th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('orders', 'customerName')">Customer ${this.getSortIcon('orders', 'customerName')}</th>
                                    <th class="px-4 py-3">Items</th>
                                    <th class="px-4 py-3">Total</th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-gray-100 select-none" onclick="app.toggleSort('orders', 'status')">Status ${this.getSortIcon('orders', 'status')}</th>
                                    <th class="px-4 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${orders.map(o => {
                                    const orderImages = this.getOrderImages(o);
                                    return `
                                    <tr class="hover:bg-gray-50 search-item" data-search="${o.id} ${o.customerName}">
                                        <td class="px-4 py-3 font-medium text-gray-900">${o.id}</td>
                                        <td class="px-4 py-3">
                                            <div class="flex -space-x-2">
                                                ${orderImages.slice(0, 3).map((img, idx) => `
                                                    <img src="${img}" onclick="event.stopPropagation(); app.openLightbox(${JSON.stringify(orderImages).replace(/"/g, '&quot;')}, ${idx})" 
                                                         class="w-8 h-8 rounded-full border-2 border-white object-cover cursor-pointer hover:scale-110 transition-transform shadow-sm">
                                                `).join('')}
                                                ${orderImages.length > 3 ? `
                                                    <div onclick="event.stopPropagation(); app.openLightbox(${JSON.stringify(orderImages).replace(/"/g, '&quot;')}, 3)" 
                                                         class="w-8 h-8 rounded-full border-2 border-white bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600 cursor-pointer hover:bg-gray-300">
                                                        +${orderImages.length - 3}
                                                    </div>
                                                ` : ''}
                                                ${orderImages.length === 0 ? '<span class="text-gray-300 text-xs">-</span>' : ''}
                                            </div>
                                        </td>
                                        <td class="px-4 py-3">${this.formatDate(o.date)}</td>
                                        <td class="px-4 py-3">${o.customerName}</td>
                                        <td class="px-4 py-3">${o.items.length}</td>
                                        <td class="px-4 py-3">${this.formatCurrency(this.calculateOrderTotal(o))}</td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${this.getStatusColor(o.status)}">${o.status}</span></td>
                                        <td class="px-4 py-3 text-right">
                                            <button onclick="app.downloadOrderFormPdf('${o.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2" title="Download Order Form PDF"><i class="fa-solid fa-file-arrow-down"></i></button>
                                            <button onclick="app.viewOrder('${o.id}')" class="text-gray-600 hover:text-gray-900 mr-2" title="View Challan"><i class="fa-solid fa-eye"></i></button>
                                            <button onclick="app.navigateToOrderForm('${o.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Edit"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="app.deleteItem('orders', '${o.id}')" class="text-red-600 hover:text-red-900" title="Delete"><i class="fa-solid fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                                ${orders.length === 0 ? '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-400">No orders found</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Initialize datepickers after DOM is rendered
                setTimeout(() => this.initDatePickers(), 50);
            },

            renderReports(container) {
                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Reports</h2>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Report Type</label>
                                <select id="report-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 bg-white">
                                    <option value="all">All Orders</option>
                                    <option value="pending">Pending Orders</option>
                                    <option value="completed">Completed Orders</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="app.generateReport()" class="bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 shadow-sm w-full font-medium">Generate Report</button>
                            </div>
                        </div>
                        <div id="report-result" class="overflow-x-auto border-t pt-4 hidden"></div>
                    </div>
                `;
            },

            // --- CONFIGURATIONS PAGE (like Masters) ---
            setConfigurationTab(tab) {
                this.configurationTab = tab;
                this.renderConfiguration(document.getElementById('content-area'));
            },

            renderConfiguration(container) {
                const tabs = [
                    { key: 'firm', label: 'Firm', icon: 'fa-building' },
                    { key: 'firebase', label: 'Firebase Setting', icon: 'fa-database' },
                    { key: 'password', label: 'Change Password', icon: 'fa-key' }
                ];

                const activeTab = this.configurationTab || 'firm';
                let contentHtml = '';

                if (activeTab === 'firm') {
                    contentHtml = this.renderConfigFirmContent();
                } else if (activeTab === 'firebase') {
                    contentHtml = this.renderConfigFirebaseContent();
                } else if (activeTab === 'password') {
                    contentHtml = this.renderConfigPasswordContent();
                }

                container.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                        <h2 class="text-2xl font-bold">Configurations</h2>
                        <div class="text-xs text-gray-500">Manage system settings</div>
                    </div>

                    <!-- Mobile View (Grid) -->
                    <div class="md:hidden grid grid-cols-3 gap-2 mb-4">
                        ${tabs.map(t => {
                            const isActive = t.key === activeTab;
                            return `
                                <button onclick="app.setConfigurationTab('${t.key}')" class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}">
                                    <i class="fa-solid ${t.icon} text-lg mb-1"></i>
                                    <span class="text-[10px] font-bold leading-tight text-center">${t.label}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>

                    <!-- Desktop View (Horizontal Tabs) -->
                    <div class="hidden md:block bg-white rounded-lg shadow-sm p-2 mb-4">
                        <div class="flex gap-2 flex-wrap">
                            ${tabs.map(t => {
                                const isActive = t.key === activeTab;
                                return `
                                    <button onclick="app.setConfigurationTab('${t.key}')" class="px-4 py-2 rounded-lg text-sm font-bold border transition-colors flex items-center gap-2 ${isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-gray-50 text-gray-700 border-gray-200 hover:bg-gray-100'}">
                                        <i class="fa-solid ${t.icon}"></i>
                                        <span>${t.label}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Config Content -->
                    <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
                        ${contentHtml}
                    </div>
                `;
            },

            renderConfigFirmContent() {
                const c = this.companyConfig;
                return `
                    <div class="space-y-6">
                        <!-- Logo Section -->
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Company Logo</label>
                            <div class="flex items-center gap-4">
                                <div class="w-24 h-24 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-white ${c.logo ? '' : 'hover:border-indigo-400'}">
                                    ${c.logo ? `
                                        <img src="${c.logo}" class="w-full h-full object-contain">
                                    ` : `
                                        <div class="text-center text-gray-400">
                                            <i class="fa-solid fa-image text-2xl mb-1"></i>
                                            <div class="text-[10px]">No Logo</div>
                                        </div>
                                    `}
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold cursor-pointer hover:bg-indigo-700 transition-colors inline-flex items-center gap-2">
                                        <i class="fa-solid fa-upload"></i> Upload Logo
                                        <input type="file" accept="image/*" onchange="app.handleCompanyLogo(this)" class="hidden">
                                    </label>
                                    ${c.logo ? `
                                        <button onclick="app.removeCompanyLogo()" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors">
                                            <i class="fa-solid fa-trash mr-1"></i> Remove
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Basic Info -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-building text-indigo-500"></i> Basic Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Company / Firm Name</label>
                                    <input type="text" id="company-name" value="${c.name || ''}" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Company Name">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Address</label>
                                    <textarea id="company-address" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Street Address">${c.address || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">City</label>
                                    <input type="text" id="company-city" value="${c.city || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="City">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">State</label>
                                    <input type="text" id="company-state" value="${c.state || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="State">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pincode</label>
                                    <input type="text" id="company-pincode" value="${c.pincode || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Pincode">
                                </div>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-phone text-indigo-500"></i> Contact Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone Number</label>
                                    <input type="tel" id="company-phone" value="${c.phone || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="+91 XXXXX XXXXX">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                                    <input type="email" id="company-email" value="${c.email || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="email@company.com">
                                </div>
                            </div>
                        </div>

                        <!-- Tax Info -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-file-invoice text-indigo-500"></i> Tax Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">GST Number</label>
                                    <input type="text" id="company-gst" value="${c.gstNumber || ''}" class="w-full border border-gray-300 rounded-lg p-3 uppercase" placeholder="22AAAAA0000A1Z5">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">PAN Number</label>
                                    <input type="text" id="company-pan" value="${c.panNumber || ''}" class="w-full border border-gray-300 rounded-lg p-3 uppercase" placeholder="AAAAA0000A">
                                </div>
                            </div>
                        </div>

                        <!-- Bank Details -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-university text-indigo-500"></i> Bank Details
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bank Name</label>
                                    <input type="text" id="company-bank" value="${c.bankName || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Bank Name">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Account Number</label>
                                    <input type="text" id="company-account" value="${c.accountNumber || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Account Number">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">IFSC Code</label>
                                    <input type="text" id="company-ifsc" value="${c.ifscCode || ''}" class="w-full border border-gray-300 rounded-lg p-3 uppercase" placeholder="SBIN0001234">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Branch Name</label>
                                    <input type="text" id="company-branch" value="${c.branchName || ''}" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Branch Name">
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="pt-4 border-t">
                            <button onclick="app.saveCompanyConfig()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                <i class="fa-solid fa-save mr-2"></i> Save Company Details
                            </button>
                        </div>
                    </div>
                `;
            },

            renderConfigFirebaseContent() {
                const isConnected = Store.useFirebase;
                let config = localStorage.getItem('oms_firebase_config');
                if (!config) {
                    config = JSON.stringify({
                        apiKey: "AIzaSyBJIyDmTEn7BgsPy_tx1wgxwA1gFmqX7fI",
                        authDomain: "fab-oms.firebaseapp.com",
                        projectId: "fab-oms",
                        storageBucket: "fab-oms.appspot.com",
                        messagingSenderId: "21494584900",
                        appId: "1:21494584900:web:f028d5e99881136c21ce11"
                    }, null, 4);
                }

                return `
                    <div class="space-y-4">
                        <!-- Connection Status -->
                        <div class="p-4 rounded-lg ${isConnected ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${isConnected ? 'bg-green-100 text-green-600' : 'bg-gray-200 text-gray-500'} flex items-center justify-center">
                                    <i class="fa-solid ${isConnected ? 'fa-cloud-check' : 'fa-hard-drive'}"></i>
                                </div>
                                <div>
                                    <div class="font-bold ${isConnected ? 'text-green-800' : 'text-gray-700'}">${isConnected ? 'Connected to Cloud Database' : 'Using Local Storage'}</div>
                                    <div class="text-sm ${isConnected ? 'text-green-600' : 'text-gray-500'}">${isConnected ? 'Real-time sync enabled' : 'Data stored in browser only'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 border border-blue-100">
                            <i class="fa-solid fa-info-circle mr-1"></i> Paste your Firebase Configuration JSON below to enable Realtime Cloud Storage.
                        </div>
                        
                        <textarea id="db-config" rows="6" class="w-full border rounded-lg p-3 text-xs font-mono bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder='{"apiKey": "...", "authDomain": "...", "projectId": "..."}'>${config}</textarea>
                        
                        <div class="flex flex-col md:flex-row gap-3 pt-2">
                            <button onclick="app.saveDbSettings()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold shadow-sm transition-colors">
                                <i class="fa-solid fa-plug mr-2"></i>Connect & Save
                            </button>
                            <button onclick="app.clearDbSettings()" class="flex-1 bg-red-50 text-red-700 py-3 rounded-lg hover:bg-red-100 font-bold border border-red-200 transition-colors">
                                <i class="fa-solid fa-unlink mr-2"></i>Disconnect
                            </button>
                        </div>
                        
                        <!-- Help Section -->
                        <div class="mt-6 border-t pt-4">
                            <h4 class="font-bold text-sm text-gray-700 mb-2">How to configure Firebase:</h4>
                            <ol class="list-decimal pl-4 space-y-2 text-xs text-gray-600">
                                <li>Go to <a href="https://console.firebase.google.com" target="_blank" class="text-indigo-600 underline">Firebase Console</a> and create a project.</li>
                                <li><strong>Get Config:</strong> Project Settings > General > Your apps > Add Web App. Copy the object inside <code>const firebaseConfig = { ... }</code>.</li>
                                <li><strong>Setup Database:</strong> Go to "Firestore Database" in the sidebar and click "Create Database".</li>
                                <li><strong>Set Rules:</strong> Go to the "Rules" tab in Firestore and allow access.</li>
                            </ol>
                        </div>
                    </div>
                `;
            },

            renderConfigPasswordContent() {
                return `
                    <div class="max-w-md mx-auto">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mx-auto mb-3">
                                <i class="fa-solid fa-key text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-lg text-gray-900">Change Password</h4>
                            <p class="text-sm text-gray-500">Update your account password</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Password</label>
                                <div class="relative">
                                    <input type="password" id="current-password" class="w-full border border-gray-300 rounded-lg p-3 pr-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter current password">
                                    <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">New Password</label>
                                <div class="relative">
                                    <input type="password" id="new-password" class="w-full border border-gray-300 rounded-lg p-3 pr-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter new password">
                                    <i class="fa-solid fa-key absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Confirm New Password</label>
                                <div class="relative">
                                    <input type="password" id="confirm-password" class="w-full border border-gray-300 rounded-lg p-3 pr-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Confirm new password">
                                    <i class="fa-solid fa-check-double absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                                <i class="fa-solid fa-exclamation-triangle mr-1"></i>
                                Password must be at least 4 characters long.
                            </div>

                            <button onclick="app.changePassword()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all mt-4">
                                <i class="fa-solid fa-check mr-2"></i> Update Password
                            </button>
                        </div>
                    </div>
                `;
            },

            // --- MODALS ---
            openModal(contentHtml) {
                const modal = document.getElementById('modal-container');
                document.getElementById('modal-content').innerHTML = contentHtml;
                modal.classList.remove('hidden');
                // Apply UI terminology changes inside modals too
                this.applyTerminology(modal);
            },

            closeModal() {
                document.getElementById('modal-container').classList.add('hidden');
                // Do not clear tempOrder here because the Order Form uses modals for item add/edit.
                // tempOrder is cleared when leaving the order-form route or after saving.
            },

            // --- SETTINGS MODULE ---
            companyConfig: {
                name: '',
                logo: '',
                address: '',
                city: '',
                state: '',
                pincode: '',
                phone: '',
                email: '',
                gstNumber: '',
                panNumber: '',
                bankName: '',
                accountNumber: '',
                ifscCode: '',
                branchName: ''
            },

            async loadCompanyConfig() {
                if (Store.useFirebase && Store.db) {
                    try {
                        const doc = await Store.db.collection('settings').doc('company').get();
                        if (doc.exists) {
                            this.companyConfig = { ...this.companyConfig, ...doc.data() };
                            this.updateCompanyBranding();
                        }
                    } catch (e) { console.error("Load config error", e); }
                } else {
                    const saved = localStorage.getItem('oms_company_config');
                    if (saved) {
                        this.companyConfig = { ...this.companyConfig, ...JSON.parse(saved) };
                        this.updateCompanyBranding();
                    }
                }
            },

            updateCompanyBranding() {
                const c = this.companyConfig;
                const name = c.name || 'Fabric OMS';
                
                // Update Sidebar
                const sidebarName = document.getElementById('sidebar-company-name');
                if (sidebarName) sidebarName.textContent = name;
                
                const sidebarLogo = document.getElementById('sidebar-logo');
                if (sidebarLogo && c.logo) {
                    sidebarLogo.outerHTML = `<img src="${c.logo}" id="sidebar-logo" class="w-8 h-8 rounded object-contain">`;
                }

                // Update Mobile Header
                const mobileName = document.getElementById('mobile-company-name');
                if (mobileName) mobileName.textContent = name;

                // Update Login Page
                const loginName = document.getElementById('login-company-name');
                if (loginName) loginName.textContent = name;

                const loginLogoContainer = document.getElementById('login-logo-container');
                if (loginLogoContainer && c.logo) {
                    loginLogoContainer.innerHTML = `<img src="${c.logo}" class="w-full h-full object-contain">`;
                    loginLogoContainer.classList.remove('bg-indigo-100', 'text-indigo-600');
                } else if (loginLogoContainer) {
                    loginLogoContainer.innerHTML = `<i class="fa-solid fa-layer-group text-3xl"></i>`;
                    loginLogoContainer.classList.add('bg-indigo-100', 'text-indigo-600');
                }

                // Update Window Title
                document.title = name;
            },

            async saveCompanyConfig() {
                const config = {
                    name: document.getElementById('company-name')?.value || '',
                    logo: this.companyConfig.logo || '',
                    address: document.getElementById('company-address')?.value || '',
                    city: document.getElementById('company-city')?.value || '',
                    state: document.getElementById('company-state')?.value || '',
                    pincode: document.getElementById('company-pincode')?.value || '',
                    phone: document.getElementById('company-phone')?.value || '',
                    email: document.getElementById('company-email')?.value || '',
                    gstNumber: document.getElementById('company-gst')?.value || '',
                    panNumber: document.getElementById('company-pan')?.value || '',
                    bankName: document.getElementById('company-bank')?.value || '',
                    accountNumber: document.getElementById('company-account')?.value || '',
                    ifscCode: document.getElementById('company-ifsc')?.value || '',
                    branchName: document.getElementById('company-branch')?.value || ''
                };

                this.companyConfig = config;

                if (Store.useFirebase && Store.db) {
                    await Store.db.collection('settings').doc('company').set(config);
                } else {
                    localStorage.setItem('oms_company_config', JSON.stringify(config));
                }

                this.updateCompanyBranding();
                this.showToast('Company configuration saved successfully');
                this.renderConfiguration(document.getElementById('content-area'));
            },

            handleCompanyLogo(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.companyConfig.logo = e.target.result;
                        this.renderConfiguration(document.getElementById('content-area'));
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            removeCompanyLogo() {
                this.companyConfig.logo = '';
                this.renderConfiguration(document.getElementById('content-area'));
            },

            async changePassword() {
                const currentPass = document.getElementById('current-password')?.value || '';
                const newPass = document.getElementById('new-password')?.value || '';
                const confirmPass = document.getElementById('confirm-password')?.value || '';

                if (!currentPass || !newPass || !confirmPass) {
                    this.showToast('Please fill all password fields');
                    return;
                }

                if (newPass !== confirmPass) {
                    this.showToast('New passwords do not match');
                    return;
                }

                if (newPass.length < 4) {
                    this.showToast('Password must be at least 4 characters');
                    return;
                }

                // Check current password
                const user = Store.data.users.find(u => u.username === 'admin');
                if (!user || user.password !== currentPass) {
                    this.showToast('Current password is incorrect');
                    return;
                }

                // Update password
                user.password = newPass;
                
                if (Store.useFirebase && Store.db) {
                    await Store.db.collection('settings').doc('users').set({ users: Store.data.users });
                } else {
                    Store.saveLocal();
                }

                this.showToast('Password changed successfully');
                this.renderConfiguration(document.getElementById('content-area'));
            },

            openDbSettings() {
                window.location.hash = 'configuration';
            },

            // For login screen - opens a simple modal for DB config before login
            showDbSettingsPrompt() {
                const config = localStorage.getItem('oms_firebase_config') || '';
                const html = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Database Configuration</h3>
                            <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800 border border-blue-100 mb-4">
                            <i class="fa-solid fa-info-circle mr-1"></i> Configure Firebase to enable cloud sync. Leave empty to use local storage.
                        </div>
                        <textarea id="login-db-config" rows="6" class="w-full border rounded-lg p-3 text-xs font-mono bg-gray-50 mb-4" placeholder='{"apiKey": "...", "projectId": "..."}'>${config}</textarea>
                        <div class="flex gap-3">
                            <button onclick="app.saveLoginDbConfig()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold">Save & Connect</button>
                            <button onclick="app.clearLoginDbConfig()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold">Use Local</button>
                        </div>
                    </div>
                `;
                this.openModal(html);
            },

            saveLoginDbConfig() {
                const configStr = document.getElementById('login-db-config').value;
                if (configStr.trim()) {
                    try {
                        const parsed = JSON.parse(configStr);
                        const normalized = Store.normalizeFirebaseConfig(parsed);
                        localStorage.setItem('oms_firebase_config', JSON.stringify(normalized, null, 4));
                        this.showToast('Configuration saved. Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } catch(e) {
                        alert('Invalid JSON Configuration');
                    }
                } else {
                    localStorage.removeItem('oms_firebase_config');
                    window.location.reload();
                }
            },

            clearLoginDbConfig() {
                localStorage.removeItem('oms_firebase_config');
                this.closeModal();
                window.location.reload();
            },

            saveDbSettings() {
                const configStr = document.getElementById('db-config').value;
                try {
                    const parsed = JSON.parse(configStr); // Validate JSON
                    const normalized = Store.normalizeFirebaseConfig(parsed);
                    localStorage.setItem('oms_firebase_config', JSON.stringify(normalized, null, 4));
                    this.showToast('Configuration Saved. Reloading...');
                    setTimeout(() => window.location.reload(), 1000);
                } catch(e) {
                    alert('Invalid JSON Configuration');
                }
            },

            clearDbSettings() {
                if(confirm('Disconnect from Cloud DB? Data will be served from this device only.')) {
                    localStorage.removeItem('oms_firebase_config');
                    window.location.reload();
                }
            },

            // Customers Modal
            openCustomerModal(id = null) {
                const c = id ? Store.getById('customers', id) : { name:'', phone:'', company:'', email:'', city:'', address:'' };
                const isEdit = !!id;
                
                const formHtml = `
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-lg font-bold text-gray-900">${isEdit ? 'Edit' : 'New'} Party</h3>
                            <button onclick="app.closeModal()" class="text-gray-500 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-1">
                            <form id="cust-form" onsubmit="event.preventDefault(); app.saveCustomer('${id || ''}')" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Name *</label><input type="text" id="c-name" value="${c.name || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Phone *</label><input type="tel" id="c-phone" value="${c.phone || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Company</label><input type="text" id="c-company" value="${c.company || ''}" class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">City</label><input type="text" id="c-city" value="${c.city || ''}" class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Address</label><textarea id="c-address" class="mt-1 block w-full border border-gray-300 rounded-md p-3">${c.address || ''}</textarea></div>
                            </form>
                        </div>
                        <div class="pt-4 mt-auto border-t">
                             <button onclick="document.getElementById('cust-form').dispatchEvent(new Event('submit'))" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg">Save Party</button>
                        </div>
                    </div>
                `;
                this.openModal(formHtml);
            },

            async saveCustomer(id) {
                this.toggleLoading(true);
                const data = {
                    name: document.getElementById('c-name').value,
                    phone: document.getElementById('c-phone').value,
                    company: document.getElementById('c-company').value,
                    address: document.getElementById('c-address').value,
                    city: document.getElementById('c-city').value
                };
                
                if (id) {
                    await Store.update('customers', id, data);
                } else {
                    data.id = 'CUST-' + Date.now();
                    await Store.add('customers', data);
                }
                this.toggleLoading(false);
                this.closeModal();
                if(this.currentRoute === 'customers') this.renderCustomers(document.getElementById('content-area'));
                this.showToast('Customer Saved');
            },

            // Brokers Modal
            openBrokerModal(id = null) {
                const b = id ? Store.getById('brokers', id) : { name:'', phone:'', commission:'' };
                const isEdit = !!id;
                
                const formHtml = `
                    <div class="flex flex-col h-full bg-white md:rounded-lg">
                         <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-lg font-bold text-gray-900">${isEdit ? 'Edit' : 'New'} Broker</h3>
                            <button onclick="app.closeModal()" class="text-gray-500 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>
                        <form id="broker-form" onsubmit="event.preventDefault(); app.saveBroker('${id || ''}')" class="space-y-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Name *</label><input type="text" id="b-name" value="${b.name || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Phone *</label><input type="tel" id="b-phone" value="${b.phone || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Commission (%)</label><input type="number" id="b-commission" value="${b.commission || ''}" class="mt-1 block w-full border border-gray-300 rounded-md p-3"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg mt-6 font-bold">Save Broker</button>
                        </form>
                    </div>
                `;
                this.openModal(formHtml);
            },

            async saveBroker(id) {
                this.toggleLoading(true);
                const data = {
                    name: document.getElementById('b-name').value,
                    phone: document.getElementById('b-phone').value,
                    commission: document.getElementById('b-commission').value
                };
                
                if (id) {
                    await Store.update('brokers', id, data);
                } else {
                    data.id = 'BRK-' + Date.now();
                    await Store.add('brokers', data);
                }
                this.toggleLoading(false);
                this.closeModal();
                if(this.currentRoute === 'brokers') this.renderBrokers(document.getElementById('content-area'));
                this.showToast('Broker Saved');
            },

            // Masters Modal
            openMasterModal(type, id = null) {
                const typeLabels = {
                    'designs': 'Design',
                    'mills': 'Mill',
                    'yarns': 'Yarn',
                    'greyGsms': 'Grey GSM',
                    'spandexes': 'Spandex',
                    'fabrics': 'Fabric Type',
                    'units': 'Unit'
                };
                const typeIcons = {
                    'designs': 'fa-palette',
                    'mills': 'fa-industry',
                    'yarns': 'fa-ring',
                    'greyGsms': 'fa-weight-scale',
                    'spandexes': 'fa-wave-square',
                    'fabrics': 'fa-scroll',
                    'units': 'fa-ruler'
                };
                
                const label = typeLabels[type] || type;
                const icon = typeIcons[type] || 'fa-database';
                const isEdit = id !== null;
                
                let existingItem = null;
                if (isEdit) {
                    existingItem = Store.data.masters[type]?.find(x => x.id === id);
                }
                
                const html = `
                    <div class="flex flex-col h-full bg-white md:rounded-lg overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                                <h3 class="font-bold text-lg text-gray-900">${isEdit ? 'Edit' : 'Add'} ${label}</h3>
                            </div>
                            <button onclick="app.closeModal()" class="text-gray-500 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">${label} Name *</label>
                                <input type="text" id="master-name" value="${existingItem?.name || ''}" 
                                    class="w-full border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-lg font-medium text-gray-800 bg-gray-50 border" 
                                    placeholder="Enter ${label.toLowerCase()} name...">
                            </div>
                            ${type !== 'units' ? `
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Description (Optional)</label>
                                <textarea id="master-description" rows="2"
                                    class="w-full border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-gray-800 bg-gray-50 border" 
                                    placeholder="Brief description...">${existingItem?.description || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Status</label>
                                <select id="master-status" class="w-full border-gray-300 rounded-lg p-3 bg-white border">
                                    <option value="Active" ${existingItem?.status === 'Active' || !existingItem ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${existingItem?.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="p-4 border-t bg-gray-50 flex gap-3">
                            <button onclick="app.closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-colors">
                                Cancel
                            </button>
                            <button onclick="app.saveMasterItem('${type}', ${id})" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                                ${isEdit ? 'Update' : 'Add'} ${label}
                            </button>
                        </div>
                    </div>
                `;
                this.openModal(html);
                
                // Focus on input after modal opens
                setTimeout(() => document.getElementById('master-name')?.focus(), 100);
            },

            async saveMasterItem(type, id) {
                const name = document.getElementById('master-name')?.value?.trim();
                const description = document.getElementById('master-description')?.value?.trim() || '';
                const status = document.getElementById('master-status')?.value || 'Active';
                
                if (!name) {
                    this.showToast('Name is required');
                    return;
                }
                
                // BULLETPROOF: Ensure masters object and specific array exist
                if (!Store.data.masters) {
                    Store.data.masters = { fabrics: [], units: [], designs: [], mills: [] };
                }
                if (!Array.isArray(Store.data.masters[type])) {
                    Store.data.masters[type] = [];
                }
                
                if (id !== null) {
                    // Edit existing
                    const index = Store.data.masters[type].findIndex(x => x.id === id);
                    if (index > -1) {
                        Store.data.masters[type][index] = {
                            ...Store.data.masters[type][index],
                            name,
                            description,
                            status
                        };
                    }
                } else {
                    // Add new
                    const newItem = {
                        id: Date.now(),
                        name,
                        description,
                        status
                    };
                    Store.data.masters[type].push(newItem);
                }
                
                await Store.saveMasters();
                
                this.closeModal();
                this.showToast(id !== null ? 'Updated successfully' : 'Added successfully');
                this.renderMasters(document.getElementById('content-area'));
            },

            confirmDeleteMaster(type, id, name) {
                const typeLabels = {
                    'designs': 'design',
                    'mills': 'mill',
                    'yarns': 'yarn',
                    'greyGsms': 'grey gsm',
                    'spandexes': 'spandex',
                    'fabrics': 'fabric type',
                    'units': 'unit'
                };
                const label = typeLabels[type] || 'item';
                
                const html = `
                    <div class="p-6 text-center">
                        <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-trash text-red-500 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Delete ${label}?</h3>
                        <p class="text-gray-500 mb-6">Are you sure you want to delete "<strong>${name}</strong>"? This action cannot be undone.</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="app.closeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-colors">
                                Cancel
                            </button>
                            <button onclick="app.deleteMaster('${type}', ${id})" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors">
                                <i class="fa-solid fa-trash mr-2"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                this.openModal(html);
            },

            async deleteMaster(type, id) {
                Store.data.masters[type] = Store.data.masters[type].filter(x => x.id !== id);
                await Store.saveMasters();
                this.closeModal();
                this.showToast('Deleted successfully');
                this.renderMasters(document.getElementById('content-area'));
            },

            // Order Logic
            tempOrder: null,
            editingOrderId: null,

            navigateToOrderForm(id = null) {
                this.editingOrderId = id;
                window.location.hash = 'order-form';
            },

            renderOrderFormPage(container) {
                const customers = Store.getAll('customers');
                const brokers = Store.getAll('brokers');
                const units = Store.data.masters.units;
                const mills = Store.data.masters.mills || [];
                const isEdit = !!this.editingOrderId;

                if (customers.length === 0) {
                    alert('Please add customers first.');
                    window.location.hash = 'orders';
                    return;
                }

                // Initialize tempOrder if needed
                if (!this.tempOrder || (isEdit && this.tempOrder.id !== this.editingOrderId) || (!isEdit && this.tempOrder.id)) {
                     if (isEdit) {
                        const existing = Store.getById('orders', this.editingOrderId);
                        if(existing) this.tempOrder = JSON.parse(JSON.stringify(existing));
                        else this.tempOrder = this.createEmptyOrder(customers);
                    } else {
                        this.tempOrder = this.createEmptyOrder(customers);
                    }
                }

                // Migration: move mill from items -> order level (for old data)
                if (this.tempOrder && (!this.tempOrder.millId && !this.tempOrder.millName)) {
                    const firstItem = (this.tempOrder.items || [])[0];
                    if (firstItem && (firstItem.millId || firstItem.millName)) {
                        this.tempOrder.millId = firstItem.millId || '';
                        this.tempOrder.millName = firstItem.millName || '';
                    }
                }
                
                const o = this.tempOrder;

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-gray-50 max-w-4xl mx-auto">
                        <!-- Header -->
                        <div class="flex justify-between items-center bg-white p-4 sticky top-0 z-30 shadow-sm">
                            <div class="flex items-center gap-3">
                                <button onclick="window.history.back()" class="text-gray-500 hover:text-gray-800 p-2 -ml-2">
                                    <i class="fa-solid fa-arrow-left text-xl"></i>
                                </button>
                                <h3 class="text-lg font-bold text-gray-900">${isEdit ? 'Edit' : 'New'} Order</h3>
                            </div>
                        </div>
                        
                        <!-- Form Content -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-32">
                             <!-- Order Header Card -->
                            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4 border border-gray-100">
                                <h4 class="font-bold text-gray-800 border-b pb-2 mb-2 flex items-center gap-2">
                                    <i class="fa-regular fa-calendar text-indigo-500"></i> Order Details
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                                        <input type="date" id="o-date" value="${o.date}" onchange="app.updateTempOrder('date', this.value)" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 border focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
                                        <select onchange="app.updateTempOrder('status', this.value)" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 border focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                                            <option value="New" ${o.status === 'New' ? 'selected' : ''}>New</option>
                                            <option value="In Progress" ${o.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Completed" ${o.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Party</label>
                                        <select onchange="app.updateTempOrder('customerId', this.value)" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 border focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                                            <option value="" ${!o.customerId ? 'selected' : ''}>-- Select Party --</option>
                                            ${customers.map(c => `<option value="${c.id}" ${c.id === o.customerId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mill</label>
                                        <select onchange="app.updateTempOrderMill(this.value)" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 border focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                                            <option value="" ${!o.millId ? 'selected' : ''}>-- Select Mill --</option>
                                            ${(mills || []).map(m => `<option value="${m.id}" ${String(m.id) === String(o.millId) ? 'selected' : ''}>${m.name}</option>`).join('')}
                                        </select>
                                        ${(mills || []).length === 0 ? '<p class="text-xs text-red-500 mt-1">Please add mills in Masters first</p>' : ''}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Broker (Optional)</label>
                                    <select onchange="app.updateTempOrder('brokerId', this.value)" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 border focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                                        <option value="">-- None --</option>
                                        ${brokers.map(b => `<option value="${b.id}" ${b.id === o.brokerId ? 'selected' : ''}>${b.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Items (Mobile-friendly: summary list + item modal) -->
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-bold text-gray-800 flex items-center gap-2">
                                        <i class="fa-solid fa-shirt text-indigo-500"></i> Items (${o.items.length})
                                    </h4>
                                </div>

                                <button onclick="app.openItemModal()" class="w-full bg-white border-2 border-dashed border-indigo-200 text-indigo-700 px-4 py-3 rounded-xl font-bold text-sm hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2">
                                    <span class="w-7 h-7 rounded-full bg-indigo-100 flex items-center justify-center"><i class="fa-solid fa-plus"></i></span>
                                    Add Item
                                </button>

                                <div id="order-items-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 pb-10">
                                    ${o.items.map((item, index) => this.renderOrderItemSummary(item, index)).join('')}
                                    ${o.items.length === 0 ? '<div class="md:col-span-2 p-8 text-center text-gray-400">No items added yet</div>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="fixed bottom-0 left-0 right-0 md:absolute bg-white border-t p-4 flex items-center justify-between z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] pb-safe">
                             <div class="flex flex-col">
                                <span class="text-xs text-gray-500 font-bold uppercase">Total Amount</span>
                                <span class="text-xl font-bold text-indigo-700">${this.formatCurrency(this.calculateOrderTotal(o))}</span>
                             </div>
                             <button onclick="app.saveOrder('${isEdit ? o.id : ''}')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Save Order</button>
                        </div>
                    </div>
                `;
            },

            createEmptyOrder(customers) {
                 return {
                    id: '', 
                    date: new Date().toISOString().split('T')[0],
                    // keep defaults empty even if required
                    customerId: '',
                    customerName: '',
                    brokerId: '',
                    millId: '',
                    millName: '',
                    status: 'New',
                    priority: 'Normal',
                    items: []
                };
            },

            // Item cards inside Order Form (summary view)
            renderOrderItemSummary(item, index) {
                if (!item.images) item.images = [];
                if (item.image) { item.images.push(item.image); delete item.image; }

                const qty = Number(item.qty || 0);
                const rate = Number(item.rate || 0);
                const total = qty * rate;

                const metaParts = [
                    item.yarn ? `Yarn: ${item.yarn}` : '',
                    (item.greyGsm !== undefined && item.greyGsm !== '' && item.greyGsm !== null) ? `Grey GSM: ${item.greyGsm}` : '',
                    (item.width !== undefined && item.width !== '' && item.width !== null) ? `Width: ${item.width}` : '',
                    (item.spandex !== undefined && item.spandex !== '' && item.spandex !== null) ? `Spandex: ${item.spandex}` : '',
                    (item.rollCount !== undefined && item.rollCount !== '' && item.rollCount !== null && Number(item.rollCount) > 0) ? `Roll: ${item.rollCount}` : ''
                ].filter(Boolean);

                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-indigo-200 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start gap-3">
                            <div class="min-w-0">
                                <div class="font-bold text-gray-900 truncate">${item.designName || 'Untitled Design'}</div>
                                ${metaParts.length ? `<div class="text-xs text-gray-500 mt-1">${metaParts.join('  ')}</div>` : `<div class="text-xs text-gray-400 mt-1">No specs</div>`}
                                <div class="text-xs text-gray-400 mt-1">${qty} ${item.unit || ''}  ${rate}</div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="font-bold text-indigo-700">${this.formatCurrency(total)}</div>
                            </div>
                        </div>

                        <div class="mt-3 flex items-center justify-between gap-3 border-t border-gray-50 pt-3">
                            <div class="flex items-center -space-x-2">
                                ${item.images.slice(0,3).map((img, imgIdx) => `
                                    <div class="w-8 h-8 rounded-full border-2 border-white overflow-hidden bg-gray-100 cursor-pointer hover:scale-110 transition-transform" onclick="event.stopPropagation(); app.openLightbox(${JSON.stringify(item.images).replace(/"/g, '&quot;')}, ${imgIdx})">
                                        <img src="${img}" class="w-full h-full object-cover">
                                    </div>
                                `).join('')}
                                ${item.images.length > 3 ? `
                                    <div class="w-8 h-8 rounded-full border-2 border-white bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-500 cursor-pointer hover:bg-gray-200" onclick="event.stopPropagation(); app.openLightbox(${JSON.stringify(item.images).replace(/"/g, '&quot;')}, 3)">
                                        +${item.images.length - 3}
                                    </div>
                                ` : ''}
                                ${item.images.length === 0 ? '<span class="text-xs text-gray-400">No images</span>' : ''}
                            </div>

                            <div class="flex gap-2">
                                <button onclick="app.openItemModal(${index})" class="px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 text-xs font-bold"><i class="fa-solid fa-pen mr-1"></i>Edit</button>
                                <button onclick="app.removeOrderItem(${index})" class="px-3 py-2 rounded-lg bg-red-50 text-red-700 text-xs font-bold"><i class="fa-solid fa-trash mr-1"></i>Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ===== Item Modal (mobile-friendly add/edit) =====
            tempItem: null,
            editingItemIndex: null,

            openItemModal(index = null) {
                const fabrics = Store.data.masters.fabrics || [];
                const units = Store.data.masters.units || [];
                const designs = Store.data.masters.designs || [];
                const mills = Store.data.masters.mills || [];
                this.editingItemIndex = (index === null || index === undefined) ? null : index;

                if (this.editingItemIndex !== null) {
                    const existing = this.tempOrder.items[this.editingItemIndex];
                    // Migration: strip mill fields from item into order if still present
                    if (existing && (!this.tempOrder.millId && !this.tempOrder.millName) && (existing.millId || existing.millName)) {
                        this.tempOrder.millId = existing.millId || '';
                        this.tempOrder.millName = existing.millName || '';
                    }
                    this.tempItem = JSON.parse(JSON.stringify(existing));
                    delete this.tempItem.millId;
                    delete this.tempItem.millName;
                } else {
                    // keep defaults empty even if required (user must choose)
                    this.tempItem = {
                        designId: '',
                        designName: '',
                        yarnId: '',
                        yarnName: '',
                        greyGsmId: '',
                        greyGsmName: '',
                        width: '',
                        spandexId: '',
                        spandexName: '',
                        qty: '',
                        unit: '',
                        rate: '',
                        images: []
                    };
                }

                // Ensure master dropdown selections are populated when editing legacy items
                const yarns = Store.data.masters.yarns || [];
                const greyGsms = Store.data.masters.greyGsms || [];
                const spandexes = Store.data.masters.spandexes || [];

                if (!this.tempItem.yarnId && this.tempItem.yarn) {
                    const matchYarn = yarns.find(y => y.name === this.tempItem.yarn);
                    this.tempItem.yarnId = matchYarn?.id || '';
                }
                if (!this.tempItem.greyGsmId && (this.tempItem.greyGsm || this.tempItem.greyGsmName)) {
                    const matchGsm = greyGsms.find(g => g.name === (this.tempItem.greyGsm || this.tempItem.greyGsmName));
                    this.tempItem.greyGsmId = matchGsm?.id || '';
                }
                if (!this.tempItem.spandexId && (this.tempItem.spandex || this.tempItem.spandexName)) {
                    const matchSpandex = spandexes.find(s => s.name === (this.tempItem.spandex || this.tempItem.spandexName));
                    this.tempItem.spandexId = matchSpandex?.id || '';
                }

                this.tempItem.yarnName = this.tempItem.yarnName || (yarns.find(y => String(y.id) === String(this.tempItem.yarnId))?.name || '');
                this.tempItem.greyGsmName = this.tempItem.greyGsmName || (greyGsms.find(g => String(g.id) === String(this.tempItem.greyGsmId))?.name || '');
                this.tempItem.spandexName = this.tempItem.spandexName || (spandexes.find(s => String(s.id) === String(this.tempItem.spandexId))?.name || '');

                if (!this.tempItem.images) this.tempItem.images = [];
                this.renderItemModal();
            },

            closeItemModal() {
                document.getElementById('modal-container').classList.add('hidden');
                this.tempItem = null;
                this.editingItemIndex = null;
            },

            updateTempItem(field, value) {
                if (!this.tempItem) return;
                this.tempItem[field] = value;
                // live total in modal
                const totalEl = document.getElementById('item-modal-total');
                if (totalEl) {
                    const t = (Number(this.tempItem.qty || 0) * Number(this.tempItem.rate || 0));
                    totalEl.textContent = this.formatCurrency(t);
                }
            },

            updateTempItemDesign(designId) {
                if (!this.tempItem) return;
                const designs = Store.data.masters.designs || [];
                const design = designs.find(d => d.id == designId);
                this.tempItem.designId = designId;
                this.tempItem.designName = design ? design.name : '';
            },

            updateTempItemYarn(yarnId) {
                if (!this.tempItem) return;
                const yarns = Store.data.masters.yarns || [];
                const yarn = yarns.find(y => String(y.id) === String(yarnId));
                this.tempItem.yarnId = yarnId;
                this.tempItem.yarnName = yarn ? yarn.name : '';
            },

            updateTempItemGreyGsm(greyGsmId) {
                if (!this.tempItem) return;
                const gsms = Store.data.masters.greyGsms || [];
                const gsm = gsms.find(g => String(g.id) === String(greyGsmId));
                this.tempItem.greyGsmId = greyGsmId;
                this.tempItem.greyGsmName = gsm ? gsm.name : '';
            },

            updateTempItemSpandex(spandexId) {
                if (!this.tempItem) return;
                const sps = Store.data.masters.spandexes || [];
                const sp = sps.find(s => String(s.id) === String(spandexId));
                this.tempItem.spandexId = spandexId;
                this.tempItem.spandexName = sp ? sp.name : '';
            },

            updateTempItemMill(millId) {
                if (!this.tempItem) return;
                const mills = Store.data.masters.mills || [];
                const mill = mills.find(m => m.id == millId);
                this.tempItem.millId = millId;
                this.tempItem.millName = mill ? mill.name : '';
            },

            async handleTempItemImageUpload(input) {
                if (!this.tempItem) return;
                if (input.files && input.files.length > 0) {
                    const files = Array.from(input.files);
                    const promises = files.map(file => new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    }));
                    const newImgs = (await Promise.all(promises)).filter(x => typeof x === 'string' && x.startsWith('data:image/'));
                    this.tempItem.images.push(...newImgs);
                    this.renderItemModal();
                }
            },

            removeTempItemImage(imgIndex) {
                if (!this.tempItem) return;
                this.tempItem.images.splice(imgIndex, 1);
                this.renderItemModal();
            },

            saveItemFromModal() {
                const item = this.tempItem;
                if (!item) return;

                // basic validation
                if (!item.designId) return alert('Design is required. Please add designs in Masters first.');

                // If user doesn't choose unit, fall back to first unit
                if (!item.unit) {
                    const units = Store.data.masters.units || [];
                    item.unit = units[0]?.name || 'Meters';
                }

                item.qty = Number(item.qty || 0);
                item.rate = Number(item.rate || 0);

                if (this.editingItemIndex !== null) {
                    this.tempOrder.items[this.editingItemIndex] = item;
                } else {
                    this.tempOrder.items.push(item);
                }

                this.closeItemModal();
                this.renderOrderFormPage(document.getElementById('content-area'));
            },

            renderItemModal() {
                const item = this.tempItem;
                const units = Store.data.masters.units || [];
                const designs = Store.data.masters.designs || [];
                const yarns = Store.data.masters.yarns || [];
                const gsms = Store.data.masters.greyGsms || [];
                const spandexes = Store.data.masters.spandexes || [];

                const total = (Number(item.qty || 0) * Number(item.rate || 0));

                const html = `
                    <div class="flex flex-col h-full">
                        <div class="flex items-center justify-between border-b pb-3 mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">${this.editingItemIndex !== null ? 'Edit' : 'Add'} Item</h3>
                                <p class="text-xs text-gray-500">Select design and enter specs</p>
                            </div>
                            <button onclick="app.closeItemModal()" class="text-gray-500 p-2"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-4">
                            <!-- Design Dropdown -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Design *</label>
                                <select onchange="app.updateTempItemDesign(this.value)" class="w-full border border-gray-300 rounded-lg p-3 bg-white">
                                    ${designs.length === 0 ? '<option value="">-- No designs available --</option>' : '<option value="">-- Select Design --</option>'}
                                    ${designs.map(d => `<option value="${d.id}" ${String(d.id) === String(item.designId) ? 'selected' : ''}>${d.name}</option>`).join('')}
                                </select>
                                ${designs.length === 0 ? '<p class="text-xs text-red-500 mt-1">Please add designs in Masters first</p>' : ''}
                            </div>

                            <!-- Specs -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Yarn</label>
                                    <select onchange="app.updateTempItemYarn(this.value)" class="w-full border border-gray-300 rounded-lg p-3 bg-white">
                                        ${yarns.length === 0 ? '<option value="">-- No yarns available --</option>' : '<option value="">-- Select Yarn --</option>'}
                                        ${yarns.map(y => `<option value="${y.id}" ${String(y.id) === String(item.yarnId) ? 'selected' : ''}>${y.name}</option>`).join('')}
                                    </select>
                                    ${yarns.length === 0 ? '<p class="text-xs text-red-500 mt-1">Please add yarns in Masters first</p>' : ''}
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Grey GSM</label>
                                    <select onchange="app.updateTempItemGreyGsm(this.value)" class="w-full border border-gray-300 rounded-lg p-3 bg-white">
                                        ${gsms.length === 0 ? '<option value="">-- No GSM values available --</option>' : '<option value="">-- Select GSM --</option>'}
                                        ${gsms.map(g => `<option value="${g.id}" ${String(g.id) === String(item.greyGsmId) ? 'selected' : ''}>${g.name}</option>`).join('')}
                                    </select>
                                    ${gsms.length === 0 ? '<p class="text-xs text-red-500 mt-1">Please add GSM values in Masters first</p>' : ''}
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Width</label>
                                    <input type="text" value="${item.width ?? ''}" oninput="app.updateTempItem('width', this.value)" class="w-full border border-gray-300 rounded-lg p-3" placeholder="e.g. 58" />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Spandex</label>
                                    <select onchange="app.updateTempItemSpandex(this.value)" class="w-full border border-gray-300 rounded-lg p-3 bg-white">
                                        ${spandexes.length === 0 ? '<option value="">-- No spandex values available --</option>' : '<option value="">-- Select Spandex --</option>'}
                                        ${spandexes.map(s => `<option value="${s.id}" ${String(s.id) === String(item.spandexId) ? 'selected' : ''}>${s.name}</option>`).join('')}
                                    </select>
                                    ${spandexes.length === 0 ? '<p class="text-xs text-red-500 mt-1">Please add spandex values in Masters first</p>' : ''}
                                </div>
                            </div>

                            <!-- Qty & Rate -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Roll Qty</label>
                                    <div class="flex border border-gray-300 rounded-lg overflow-hidden">
                                        <input type="number" value="${item.qty ?? ''}" oninput="app.updateTempItem('qty', this.value)" class="w-full p-3 text-center font-bold outline-none" placeholder="0" />
                                        <select onchange="app.updateTempItem('unit', this.value)" class="bg-gray-50 border-l border-gray-200 px-2 text-xs font-bold text-gray-700 w-24 shrink-0">
                                            <option value="">-- Unit --</option>
                                            ${units.map(u => `<option value="${u.name}" ${u.name == item.unit ? 'selected' : ''}>${u.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rate</label>
                                    <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                                        <span class="pl-3 text-gray-400 text-sm"></span>
                                        <input type="number" value="${item.rate ?? ''}" oninput="app.updateTempItem('rate', this.value)" class="w-full p-3 font-bold outline-none" placeholder="0" />
                                    </div>
                                </div>
                            </div>

                            <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex items-center justify-between">
                                <span class="text-xs font-bold text-indigo-500 uppercase">Item Total</span>
                                <span id="item-modal-total" class="text-xl font-bold text-indigo-700">${this.formatCurrency(total)}</span>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Images</label>
                                <div class="flex flex-wrap gap-2">
                                    ${item.images.map((img, idx) => `
                                        <div class="relative w-16 h-16 rounded-lg overflow-hidden border border-gray-200 group">
                                            <img src="${img}" onclick="app.openLightbox(${JSON.stringify(item.images).replace(/"/g, '&quot;')}, ${idx})" class="w-full h-full object-cover cursor-pointer" />
                                            <button onclick="event.stopPropagation(); app.removeTempItemImage(${idx})" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center rounded-bl-lg text-xs">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                    <label class="w-16 h-16 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-500 hover:border-indigo-400 bg-gray-50 cursor-pointer">
                                        <i class="fa-solid fa-camera text-lg mb-1"></i>
                                        <span class="text-[8px] font-bold uppercase">Add</span>
                                        <input type="file" multiple accept="image/*" onchange="app.handleTempItemImageUpload(this)" class="hidden" />
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 mt-4 border-t">
                            <button onclick="app.saveItemFromModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Save Item</button>
                        </div>
                    </div>
                `;

                this.openModal(html);
            },

            updateTempOrder(field, value) {
                this.tempOrder[field] = value;
                if (field === 'customerId') {
                    const c = Store.getById('customers', value);
                    this.tempOrder.customerName = c ? c.name : 'Unknown';
                }
            },

            updateTempOrderMill(millId) {
                if (!this.tempOrder) return;
                this.tempOrder.millId = millId;
                const mills = Store.data.masters.mills || [];
                const mill = mills.find(m => String(m.id) === String(millId));
                this.tempOrder.millName = mill ? mill.name : '';
            },

            removeOrderItem(index) {
                if (!this.tempOrder) return;
                this.tempOrder.items.splice(index, 1);
                this.renderOrderFormPage(document.getElementById('content-area'));
            },

            async saveOrder(id) {
                const o = this.tempOrder;
                if(!o.customerId) return alert('Party required');
                if(!o.millId) return alert('Mill required');
                if(o.items.length === 0) return alert('At least one item required');

                this.toggleLoading(true);
                try {
                    // Ensure IDs
                    const isNew = !id;
                    const orderId = id || (await Store.getNextChallanId(o.date));

                    // Deep clone to avoid mutating UI state while uploading
                    const payload = JSON.parse(JSON.stringify(o));
                    payload.id = orderId;
                    payload.updatedDate = new Date().toISOString();
                    if (isNew) payload.createdDate = new Date().toISOString();

                    // Normalize items
                    payload.items = (payload.items || []).map((it, idx) => {
                        let images = [];
                        if (Array.isArray(it.images)) {
                            images = it.images.filter(img => typeof img === 'string' && img.length > 0);
                        }
                        return {
                            designId: String(it.designId || ''),
                            designName: String(it.designName || ''),
                            yarn: String(it.yarnName || it.yarn || ''),
                            greyGsm: String(it.greyGsmName || it.greyGsm || ''),
                            width: String(it.width || ''),
                            spandex: String(it.spandexName || it.spandex || ''),
                            qty: Number(it.qty) || 0,
                            unit: String(it.unit || 'Meters'),
                            rate: Number(it.rate) || 0,
                            images: images
                        };
                    });

                    // Sanitize for Firestore
                    const cleanPayload = Store.sanitizeForFirestore(payload);

                    if (id) {
                        await Store.update('orders', id, cleanPayload);
                    } else {
                        await Store.add('orders', cleanPayload);
                    }

                    this.showToast('Order saved successfully');
                    this.tempOrder = null;
                    this.editingOrderId = null;
                    window.location.hash = 'orders';
                } catch (err) {
                    console.error(err);
                    alert('Failed to save order. ' + (err?.message || err));
                } finally {
                    this.toggleLoading(false);
                }
            },

            viewOrder(id) {
                const o = Store.getById('orders', id);
                if(!o) return;
                const customer = Store.getById('customers', o.customerId) || {};
                const broker = Store.getById('brokers', o.brokerId);

                const html = `
                    <div class="print-area bg-white p-6 max-w-3xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-start mb-6 border-b pb-4">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">CHALLAN</h1>
                                <p class="text-gray-500 text-sm">${o.id}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold">${this.formatDate(o.date)}</p>
                                <span class="text-xs px-2 py-1 bg-gray-100 rounded border border-gray-200">${o.status}</span>
                            </div>
                        </div>

                        <div class="mb-6 grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-1">Bill To</h3>
                                <p class="font-bold text-gray-800">${o.customerName}</p>
                                ${o.millName ? `<p class="text-sm text-gray-600"><span class="font-semibold">Mill:</span> ${o.millName}</p>` : ''}
                                <p class="text-sm text-gray-600">${customer.phone}</p>
                                <p class="text-sm text-gray-600 whitespace-pre-line">${customer.address || ''}</p>
                            </div>
                            ${broker ? `
                            <div class="text-right">
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-1">Broker</h3>
                                <p class="font-bold text-gray-800">${broker.name}</p>
                            </div>
                            ` : ''}
                        </div>

                        <div class="border rounded-lg overflow-hidden mb-6 flex-1">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="p-3">Item</th>
                                        <th class="p-3 text-right">Roll Qty</th>
                                        <th class="p-3 text-right">Rate</th>
                                        <th class="p-3 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${o.items.map((item) => {
                                        let displayImages = item.images || [];

                                        const specs = [
                                            item.yarn ? `Yarn: ${item.yarn}` : '',
                                            item.greyGsm ? `Grey GSM: ${item.greyGsm}` : '',
                                            item.width ? `Width: ${item.width}` : '',
                                            item.spandex ? `Spandex: ${item.spandex}` : ''
                                        ].filter(Boolean);

                                        return `
                                        <tr>
                                            <td class="p-3 align-top">
                                                <div class="font-bold text-gray-800">${item.designName || 'No Design Name'}</div>
                                                ${specs.length ? `<div class="text-xs text-gray-500 mb-2">${specs.join('  ')}</div>` : `<div class="text-xs text-gray-400 mb-2">No specs</div>`}
                                                ${displayImages.length > 0 ? `
                                                    <div class="flex gap-2 flex-wrap">
                                                         ${displayImages.map((img, imgIdx) => `<img src="${img}" onclick="app.openLightbox(${JSON.stringify(displayImages).replace(/"/g, '&quot;')}, ${imgIdx})" class="w-12 h-12 object-cover rounded-md border border-gray-200 cursor-pointer hover:scale-105 transition-transform">`).join('')}
                                                    </div>
                                                ` : ''}
                                            </td>
                                            <td class="p-3 text-right align-top font-medium">${item.qty} <span class="text-xs text-gray-400">${item.unit}</span></td>
                                            <td class="p-3 text-right align-top text-gray-600">${item.rate}</td>
                                            <td class="p-3 text-right align-top font-bold text-gray-900">${this.formatCurrency((item.qty || 0) * (item.rate || 0)).replace('', '')}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                                <tfoot class="bg-gray-50 border-t">
                                    <tr>
                                        <td colspan="3" class="p-4 text-right font-bold text-gray-600 uppercase text-xs tracking-wider">Grand Total</td>
                                        <td class="p-4 text-right font-bold text-xl text-indigo-700">${this.formatCurrency(this.calculateOrderTotal(o))}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="text-center no-print mt-auto pt-6 border-t border-dashed">
                            <div class="flex justify-center gap-4">
                                <button onclick="window.print()" class="bg-gray-900 text-white px-8 py-3 rounded-xl shadow-lg hover:bg-black transition-colors flex items-center font-bold">
                                    <i class="fa-solid fa-print mr-2"></i> Print
                                </button>
                                <button onclick="app.closeModal()" class="text-gray-500 px-6 py-3 hover:bg-gray-100 rounded-xl transition-colors font-medium">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                this.openModal(html);
            },

            // --- UTILS ---
            async deleteItem(collection, id) {
                if(confirm('Delete this item?')) {
                    this.toggleLoading(true);
                    await Store.delete(collection, id);
                    this.toggleLoading(false);
                    this.refreshCurrentView();
                    this.showToast('Deleted');
                }
            },

            calculateOrderTotal(order) {
                return order.items.reduce((sum, item) => sum + (item.qty * item.rate), 0);
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch (e) {
                    return dateStr;
                }
            },

            // Sorting state
            sortState: {
                orders: { column: 'createdDate', direction: 'desc' },
                customers: { column: 'name', direction: 'asc' },
                brokers: { column: 'name', direction: 'asc' }
            },

            sortData(collection, data, column, direction) {
                return [...data].sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];
                    
                    if (column.includes('date') || column.includes('Date')) {
                        valA = new Date(valA || 0).getTime();
                        valB = new Date(valB || 0).getTime();
                    }
                    else if (typeof valA === 'number' || column === 'commission') {
                        valA = Number(valA) || 0;
                        valB = Number(valB) || 0;
                    }
                    else {
                        valA = String(valA || '').toLowerCase();
                        valB = String(valB || '').toLowerCase();
                    }
                    
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            },

            toggleSort(collection, column) {
                const state = this.sortState[collection];
                if (state.column === column) {
                    state.direction = state.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    state.column = column;
                    state.direction = 'asc';
                }
                
                const content = document.getElementById('content-area');
                switch(collection) {
                    case 'orders': this.renderOrders(content); break;
                    case 'customers': this.renderCustomers(content); break;
                    case 'brokers': this.renderBrokers(content); break;
                }
            },

            getSortIcon(collection, column) {
                const state = this.sortState[collection];
                if (state.column !== column) return '<i class="fa-solid fa-sort text-gray-300 ml-1"></i>';
                return state.direction === 'asc' 
                    ? '<i class="fa-solid fa-sort-up text-indigo-500 ml-1"></i>' 
                    : '<i class="fa-solid fa-sort-down text-indigo-500 ml-1"></i>';
            },

            getStatusColor(status) {
                switch(status) {
                    case 'New': return 'bg-blue-100 text-blue-800';
                    case 'In Progress': return 'bg-yellow-100 text-yellow-800';
                    case 'Completed': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            },
            
            toggleLoading(show) {
                const el = document.getElementById('loading-overlay');
                if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
            },

            showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 3000);
            },

            // --- IMAGE LIGHTBOX ---
            lightboxImages: [],
            lightboxIndex: 0,

            openLightbox(images, startIndex = 0) {
                if (!images || images.length === 0) return;
                this.lightboxImages = Array.isArray(images) ? images : [images];
                this.lightboxIndex = startIndex;
                this.updateLightbox();
                document.getElementById('image-lightbox').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },

            closeLightbox(event) {
                if (event && event.target.id !== 'image-lightbox') return;
                document.getElementById('image-lightbox').classList.add('hidden');
                document.body.style.overflow = '';
                this.lightboxImages = [];
                this.lightboxIndex = 0;
            },

            updateLightbox() {
                const img = document.getElementById('lightbox-image');
                const counter = document.getElementById('lightbox-counter');
                img.src = this.lightboxImages[this.lightboxIndex];
                counter.textContent = `${this.lightboxIndex + 1} / ${this.lightboxImages.length}`;
                counter.style.display = this.lightboxImages.length > 1 ? 'block' : 'none';
            },

            prevImage(event) {
                event.stopPropagation();
                if (this.lightboxImages.length <= 1) return;
                this.lightboxIndex = (this.lightboxIndex - 1 + this.lightboxImages.length) % this.lightboxImages.length;
                this.updateLightbox();
            },

            nextImage(event) {
                event.stopPropagation();
                if (this.lightboxImages.length <= 1) return;
                this.lightboxIndex = (this.lightboxIndex + 1) % this.lightboxImages.length;
                this.updateLightbox();
            },

            getOrderImages(order) {
                const images = [];
                if (order.items) {
                    order.items.forEach(item => {
                        if (item.images && item.images.length) {
                            images.push(...item.images);
                        }
                    });
                }
                return images;
            },
            
            // --- ORDER FORM PDF (A4) ---
            downloadOrderFormPdf(orderId) {
                const o = Store.getById('orders', orderId);
                if (!o) {
                    this.showToast('Order not found');
                    return;
                }

                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    alert('PDF library not loaded. Please check internet connection.');
                    return;
                }

                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 40;

                const customer = Store.getById('customers', o.customerId) || {};
                const broker = Store.getById('brokers', o.brokerId) || {};

                // ========== PREMIUM HEADER ==========
                doc.setFillColor(15, 23, 42); 
                doc.rect(0, 0, pageWidth, 50, 'F');
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(255, 255, 255);
                doc.text('ORDER FORM', pageWidth / 2, 32, { align: 'center' });

                doc.setTextColor(0, 0, 0);

                let currentY = 70;
                
                doc.autoTable({
                    startY: currentY,
                    body: [
                        [
                            { content: 'CHALLAN NO:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: String(o.id || ''), styles: { fontStyle: 'bold', textColor: [79, 70, 229] } },
                            { content: 'DATE:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: this.formatDate(o.date) }
                        ],
                        [
                            { content: 'PARTY:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: String(o.customerName || '') },
                            { content: 'MILL:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: String(o.millName || '') }
                        ],
                        [
                            { content: 'BROKER:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: String(broker?.name || '-') },
                            { content: 'TOTAL:', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } },
                            { content: this.formatCurrency(this.calculateOrderTotal(o)).replace('', 'Rs. '), styles: { fontStyle: 'bold', textColor: [16, 185, 129] } }
                        ]
                    ],
                    theme: 'grid',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 8,
                        lineColor: [203, 213, 225],
                        lineWidth: 0.5,
                        valign: 'middle'
                    },
                    margin: { left: margin, right: margin },
                    tableWidth: pageWidth - margin * 2,
                    columnStyles: {
                        0: { cellWidth: (pageWidth - margin * 2) * 0.15 },
                        1: { cellWidth: (pageWidth - margin * 2) * 0.35 },
                        2: { cellWidth: (pageWidth - margin * 2) * 0.15 },
                        3: { cellWidth: (pageWidth - margin * 2) * 0.35 }
                    }
                });

                currentY = doc.lastAutoTable.finalY + 20;

                const items = Array.isArray(o.items) ? o.items : [];

                const buildRollRows = (rollQty) => {
                    const count = Number(rollQty) || 0;
                    const base = 1001;
                    const columns = 3;
                    const rows = Math.ceil(count / columns) || 1;
                    const body = [];
                    for (let r = 0; r < rows; r++) {
                        const row = [];
                        for (let c = 0; c < columns; c++) {
                            const idx = c * rows + r;
                            const rollNo = (idx < count) ? (base + idx) : '';
                            row.push(rollNo ? String(rollNo) : '');
                            row.push(''); 
                        }
                        body.push(row);
                    }
                    return body;
                };

                items.forEach((it, idx) => {
                    if (currentY > pageHeight - 200) {
                        doc.addPage();
                        currentY = 40;
                    }

                    doc.setFillColor(79, 70, 229); 
                    doc.rect(margin, currentY, pageWidth - margin * 2, 24, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`ITEM ${idx + 1}`, margin + 10, currentY + 16);
                    doc.text(`Roll Qty: ${Number(it.qty) || 0}`, pageWidth - margin - 10, currentY + 16, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    
                    currentY += 28;

                    const itemSpecsBody = [
                        [
                            { content: 'YARN', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: String(it.yarn || '-') },
                            { content: 'DESIGN', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: String(it.designName || '-'), styles: { fontStyle: 'bold' } }
                        ],
                        [
                            { content: 'GREY GSM', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: String(it.greyGsm || '-') },
                            { content: 'PICTURE', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: '', rowSpan: 3 }
                        ],
                        [
                            { content: 'WIDTH', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: String(it.width || '-') }
                        ],
                        [
                            { content: 'SPANDEX', styles: { fontStyle: 'bold', fillColor: [248, 250, 252] } },
                            { content: String(it.spandex || '-') }
                        ]
                    ];

                    doc.autoTable({
                        startY: currentY,
                        body: itemSpecsBody,
                        theme: 'grid',
                        styles: {
                            font: 'helvetica',
                            fontSize: 10,
                            cellPadding: 8,
                            lineColor: [203, 213, 225],
                            lineWidth: 0.5,
                            valign: 'middle'
                        },
                        margin: { left: margin, right: margin },
                        tableWidth: pageWidth - margin * 2,
                        columnStyles: {
                            0: { cellWidth: (pageWidth - margin * 2) * 0.18, halign: 'left' },
                            1: { cellWidth: (pageWidth - margin * 2) * 0.32, halign: 'left' },
                            2: { cellWidth: (pageWidth - margin * 2) * 0.18, halign: 'left' },
                            3: { cellWidth: (pageWidth - margin * 2) * 0.32, halign: 'center' }
                        },
                        didDrawCell: (data) => {
                            if (data.row.index === 1 && data.column.index === 3) {
                                const img = (it.images && it.images.length) ? it.images[0] : '';
                                if (img && typeof img === 'string' && img.startsWith('data:image/')) {
                                    const cell = data.cell;
                                    const imgSize = Math.min(cell.width - 16, cell.height * 2.5, 80);
                                    const imgX = cell.x + (cell.width - imgSize) / 2;
                                    const imgY = cell.y + 6;
                                    try { doc.addImage(img, 'JPEG', imgX, imgY, imgSize, imgSize * 0.75); } catch(e) {}
                                }
                            }
                        }
                    });

                    currentY = doc.lastAutoTable.finalY + 12;

                    const rollHead = [[
                        { content: 'ROLL NO.', styles: { halign: 'center' } },
                        { content: 'WEIGHT', styles: { halign: 'center' } },
                        { content: 'ROLL NO.', styles: { halign: 'center' } },
                        { content: 'WEIGHT', styles: { halign: 'center' } },
                        { content: 'ROLL NO.', styles: { halign: 'center' } },
                        { content: 'WEIGHT', styles: { halign: 'center' } }
                    ]];

                    const rollBody = buildRollRows(it.qty);

                    doc.autoTable({
                        startY: currentY,
                        head: rollHead,
                        body: rollBody,
                        theme: 'grid',
                        styles: {
                            font: 'helvetica',
                            fontSize: 9,
                            cellPadding: 6,
                            lineColor: [203, 213, 225],
                            lineWidth: 0.5,
                            halign: 'center',
                            valign: 'middle'
                        },
                        headStyles: {
                            fillColor: [51, 65, 85], 
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 9
                        },
                        alternateRowStyles: { fillColor: [248, 250, 252] },
                        margin: { left: margin, right: margin },
                        tableWidth: pageWidth - margin * 2,
                        columnStyles: {
                            0: { cellWidth: (pageWidth - margin * 2) / 6 },
                            1: { cellWidth: (pageWidth - margin * 2) / 6 },
                            2: { cellWidth: (pageWidth - margin * 2) / 6 },
                            3: { cellWidth: (pageWidth - margin * 2) / 6 },
                            4: { cellWidth: (pageWidth - margin * 2) / 6 },
                            5: { cellWidth: (pageWidth - margin * 2) / 6 }
                        }
                    });

                    currentY = doc.lastAutoTable.finalY + 25;
                });

                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
                }

                const pdfUrl = doc.output('bloburl');
                const win = window.open(pdfUrl, '_blank');
                if (!win) doc.save(`ORDER-FORM-${o.id}.pdf`);
            },
            
            generateReport() {
                 const type = document.getElementById('report-type').value;
                let orders = Store.getAll('orders');
                if (type === 'pending') orders = orders.filter(o => ['New', 'In Progress'].includes(o.status));
                if (type === 'completed') orders = orders.filter(o => o.status === 'Completed');

                const totalAmount = orders.reduce((sum, o) => sum + this.calculateOrderTotal(o), 0);
                
                const html = `
                    <div class="border rounded p-4 bg-gray-50 mb-4">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold">${type.toUpperCase()} Report</h4>
                             <span class="text-xs bg-gray-200 px-2 py-1 rounded">${orders.length} orders</span>
                        </div>
                        <div class="text-2xl font-bold text-indigo-600 mb-2">${this.formatCurrency(totalAmount)}</div>
                        <button onclick="window.print()" class="text-xs text-blue-600 hover:underline"><i class="fa-solid fa-print"></i> Print View</button>
                    </div>
                    <table class="w-full text-xs text-left">
                        <thead><tr class="border-b"><th class="pb-1">ID</th><th class="pb-1">Customer</th><th class="pb-1 text-right">Amt</th></tr></thead>
                        <tbody>
                            ${orders.length > 0 ? orders.map(o => `
                                <tr class="border-b border-gray-100">
                                    <td class="py-2">${o.id}</td>
                                    <td class="py-2 truncate max-w-[100px]">${o.customerName}</td>
                                    <td class="py-2 text-right">${this.calculateOrderTotal(o)}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="3" class="py-4 text-center text-gray-400">No data found</td></tr>'}
                        </tbody>
                    </table>
                `;
                document.getElementById('report-result').innerHTML = html;
                document.getElementById('report-result').classList.remove('hidden');
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                app.login(document.getElementById('username').value, document.getElementById('password').value);
            });
            app.init();
        });
    </script>
</body>
</html>
